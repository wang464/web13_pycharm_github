typeof JSON!="object"&&(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","  ":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(e,t){"use strict";var n=e.History=e.History||{},r=e.MooTools,i=e.Element;if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");Object.append(i.NativeEvents,{popstate:2,hashchange:2}),n.Adapter={bind:function(e,t,n){var r=typeof e=="string"?document.id(e):e;r.addEvent(t,n)},trigger:function(e,t,n){var r=typeof e=="string"?document.id(e):e;r.fireEvent(t,n)},extractEventData:function(e,n){var r=n&&n.event&&n.event[e]||n&&n[e]||t;return r},onDomLoad:function(t){e.addEvent("domready",t)}},typeof n.init!="undefined"&&n.init()}(window),function(e,t){"use strict";var n=e.document,r=e.setTimeout||r,i=e.clearTimeout||i,s=e.setInterval||s,o=e.History=e.History||{};if(typeof o.initHtml4!="undefined")throw new Error("History.js HTML4 Support has already been loaded...");o.initHtml4=function(){if(typeof o.initHtml4.initialized!="undefined")return!1;o.initHtml4.initialized=!0,o.enabled=!0,o.savedHashes=[],o.isLastHash=function(e){var t=o.getHashByIndex(),n;return n=e===t,n},o.isHashEqual=function(e,t){return e=encodeURIComponent(e).replace(/%25/g,"%"),t=encodeURIComponent(t).replace(/%25/g,"%"),e===t},o.saveHash=function(e){return o.isLastHash(e)?!1:(o.savedHashes.push(e),!0)},o.getHashByIndex=function(e){var t=null;return typeof e=="undefined"?t=o.savedHashes[o.savedHashes.length-1]:e<0?t=o.savedHashes[o.savedHashes.length+e]:t=o.savedHashes[e],t},o.discardedHashes={},o.discardedStates={},o.discardState=function(e,t,n){var r=o.getHashByState(e),i;return i={discardedState:e,backState:n,forwardState:t},o.discardedStates[r]=i,!0},o.discardHash=function(e,t,n){var r={discardedHash:e,backState:n,forwardState:t};return o.discardedHashes[e]=r,!0},o.discardedState=function(e){var t=o.getHashByState(e),n;return n=o.discardedStates[t]||!1,n},o.discardedHash=function(e){var t=o.discardedHashes[e]||!1;return t},o.recycleState=function(e){var t=o.getHashByState(e);return o.discardedState(e)&&delete o.discardedStates[t],!0},o.emulated.hashChange&&(o.hashChangeInit=function(){o.checkerFunction=null;var t="",r,i,u,a,f=Boolean(o.getHash());return o.isInternetExplorer()?(r="historyjs-iframe",i=n.createElement("iframe"),i.setAttribute("id",r),i.setAttribute("src","#"),i.style.display="none",n.body.appendChild(i),i.contentWindow.document.open(),i.contentWindow.document.close(),u="",a=!1,o.checkerFunction=function(){if(a)return!1;a=!0;var n=o.getHash(),r=o.getHash(i.contentWindow.document);return n!==t?(t=n,r!==n&&(u=r=n,i.contentWindow.document.open(),i.contentWindow.document.close(),i.contentWindow.document.location.hash=o.escapeHash(n)),o.Adapter.trigger(e,"hashchange")):r!==u&&(u=r,f&&r===""?o.back():o.setHash(r,!1)),a=!1,!0}):o.checkerFunction=function(){var n=o.getHash()||"";return n!==t&&(t=n,o.Adapter.trigger(e,"hashchange")),!0},o.intervalList.push(s(o.checkerFunction,o.options.hashChangeInterval)),!0},o.Adapter.onDomLoad(o.hashChangeInit)),o.emulated.pushState&&(o.onHashChange=function(t){var n=t&&t.newURL||o.getLocationHref(),r=o.getHashByUrl(n),i=null,s=null,u=null,a;return o.isLastHash(r)?(o.busy(!1),!1):(o.doubleCheckComplete(),o.saveHash(r),r&&o.isTraditionalAnchor(r)?(o.Adapter.trigger(e,"anchorchange"),o.busy(!1),!1):(i=o.extractState(o.getFullUrl(r||o.getLocationHref()),!0),o.isLastSavedState(i)?(o.busy(!1),!1):(s=o.getHashByState(i),a=o.discardedState(i),a?(o.getHashByIndex(-2)===o.getHashByState(a.forwardState)?o.back(!1):o.forward(!1),!1):(o.pushState(i.data,i.title,encodeURI(i.url),!1),!0))))},o.Adapter.bind(e,"hashchange",o.onHashChange),o.pushState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.pushState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getHash(),c=o.expectedStateId==s.id;return o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),u===f?(o.busy(!1),!1):(o.saveState(s),c||o.Adapter.trigger(e,"statechange"),!o.isHashEqual(u,l)&&!o.isHashEqual(u,o.getShortUrl(o.getLocationHref()))&&o.setHash(u,!1),o.busy(!1),!0)},o.replaceState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.replaceState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getStateByIndex(-2);return o.discardState(a,s,l),u===f?(o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),o.saveState(s),o.Adapter.trigger(e,"statechange"),o.busy(!1)):o.pushState(s.data,s.title,s.url,!1),!0}),o.emulated.pushState&&o.getHash()&&!o.emulated.hashChange&&o.Adapter.onDomLoad(function(){o.Adapter.trigger(e,"hashchange")})},typeof o.init!="undefined"&&o.init()}(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s=e.sessionStorage,s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window);var app=app||{};(function(){window.console||function(){var e=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];window.console={};for(var t=0;t<e.length;++t)window.console[e[t]]=function(){}}(),Object.append(app,new Events),Object.append(app,{addOnceEvent:function(e,t){var n=this,r=function(){try{t.apply(n,arguments)}finally{n.removeEvent(e,r)}};this.addEvent(e,r)}}),Object.append(app,{parsePinUrl:function(e){var t=app.host||"huaban.com",n=new RegExp("(http)?:\\/\\/"+t+"/(shiji/)?pins/(\\d+)/?"),r=e.match(n);return r?r[3].toInt():!1}}),app.isRetinaDisplay=function(){if(window.matchMedia){var e=window.matchMedia("only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen  and (min-device-pixel-ratio: 1.3), only screen and (min-resolution: 1.3dppx)");return e&&e.matches||window.devicePixelRatio>1.3?!0:!1}}(),app.COMMON_ERRMSG="网络错误，请稍候再试",app.currentUrl=location.href;var e=window.navigator.userAgent.toLowerCase();Browser.anquan360=e.indexOf("360se")>-1,Browser.jisu360=e.indexOf("360ee")>-1,Browser.qq=e.indexOf("qqbrowser")>-1,Browser.sougou=e.indexOf("metasr")>-1,Browser.maxthon=e.indexOf("maxthon")>-1,!navigator.userAgent.match(/Trident.*rv[ :]*11\./)||(Browser.ie=Browser.ie11=!0,Browser.version=11),Browser.isMobile=function(){var e=navigator.userAgent.toLowerCase();e=e.toLowerCase();var t=!!e.match(/ip(?:ad|od|hone)/),n=!!e.match(/ipad/),r=!!e.match(/(?:android)/),i=e.match(/(ucbrowser|mobile|ucweb)/g),s=e.match(/(Windows Phone)/g),o=e.match(/(MI PAD)/gi);return(t||r||i||s)&&!n&&!o}(),"undefined"!=typeof document.referrer&&!~document.referrer.indexOf(app.host)&&Cookie.write("wft","1"),window.addEvent("domready",function(){window.docScroller=new Fx.Scroll(document.body),app.view=app.view||$("page");var e=document.id("elevator_item"),t=document.id("elevator"),n=document.getElement(".add-board-item");if(e){document.id("bookmarklet")&&e.hide(),window.addEvent("scroll",function(e){window.getScrollTop()>200?t.removeClass("off"):t.addClass("off")});var r=e.getElement(".plus"),i=e.getElement(".plus-popup");new MenuController({menu:i,trigger:r,showupDelay:100})}if(t){var s=new Fx.Scroll(window,{duration:"short"});t.addEvent("click",function(){s.toTop()})}n&&n.addEvent("click",function(e){app.requireLogin(function(){app.showDialogBox("create_board")})}),function(){$$(".ts-words").each(function(e){var t=e.retrieve("PinTime");if(!t){var n=e.get("data-ts");if(!n)return;t=new Date(n.toInt()*1e3),e.store("PinTime",t)}var r=new Date;if(r-t>2592e6)return;e.set("html",t.timeAgo())})}.periodical(6e4)})})(),String.implement("stripScripts",function(e){var t="",n=this.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(e,n){return t+=";"+n+"\n",""});return e===!0?Browser.exec(t):typeOf(e)=="function"&&e(t,n),n}),Element.implement({mouseOver:function(e){var t=this.getCoordinates();return e.x>t.left&&e.x<t.right&&e.y<t.bottom&&e.y>t.top},setStyles:function(e,t){t&&this.store("styles:_old",this.getStyles(Object.keys(e)));for(var n in e)this.setStyle(n,e[n]);return this},restoreStyles:function(){var e=this.retrieve("styles:_old");return e?(this.erase("styles:_old"),this.setStyles(e)):this},absolutize:function(){var e=this.getStyle("position");if(e==="absolute")return this;var t=this.getParent();while(t&&["relative","fixed","absolute"].indexOf(t.getStyle("position"))==-1)t=t.getParent();t=t||document.body;var n=this.getCoordinates(t),r=n.top,i=n.left;if(e==="relative"||e==="static"){var s=(new Element("div")).setStyles({position:e,width:n.width,height:n.height}).inject(this,"after");this.store("absolutize:placeholder",s)}else{var o=(e==="fixed"?window:t).getScroll();r+=o.y,i+=o.x}return this.setStyles({position:"absolute",top:r,left:i,width:n.width,margin:0},!0),this},unabsolutize:function(){this.restoreStyles();var e=this.retrieve("absolutize:placeholder");return e&&e.destroy(),this},fadeAndDestroy:function(e){e=e||600;var t=this;this.set("tween",{duration:e}).fade("out").get("tween").chain(function(){t.dispose()})}}),function(){Object.append(app,{templates:{},_tplLoading:{},$revisions:{},$rev:function(e){return this.$revisions[e]||Math.floor((new Date).getTime()/1e3)},loadTemplate:function(e,t){var n=this.templates[e];if(n)return t(n);var r=e,i=e.split("/");i.length>1&&(i.pop(),r=i.join("_"));var s=this,o=function(){t(s.templates[e])};this._tplLoading[r]?this._tplLoading[r].push(o):this._tplLoading[r]=[o];var u="/js/views_"+r+".js";new Asset.javascript(u+"?"+this.$rev(u)+".js",{onLoad:function(){setTimeout(function(){var e=s._tplLoading[r];delete s._tplLoading[r];for(var t=0,n=e.length;t<n;t++)e[t].call()},10)}})},render:function(e,t,n){var r=null;typeOf(t)==="function"?(n=t,t=this):typeOf(t)==="element"&&(r=t,t=this);var i=this;this.loadTemplate(e,function(e){var s=e?e.call(i,t||i):"";r?s.stripScripts(function(e,t){r.set("html",t),e&&Browser.exec(e),n&&(s=n(e,t))}):n&&s.stripScripts(n)})},renderSync:function(e,t){var n=this.templates[e];return n?n.call(this,t||this):""},renderElements:function(e,t,n){var r=app.renderSync(e,t),i=null;return r.stripScripts(function(e,t){i=Elements.from(t),n&&(i.inject(n),Browser.exec(e))}),i}})}();var Cache=new Class({Implements:[Options],options:{duration:60,capcity:100},initialize:function(e){this.setOptions(e),this.data={}},set:function(e,t,n){return this.data[e]={key:e,value:t,expires:this.calculateDuration(n||this.options.duration),duration:n||this.options.duration,lastAccess:Date.now()},this.isFull()&&this.purge.delay(200,this),this},get:function(e){var t=this.data[e];if(!t)return null;var n=Date.now();return t.expires<=n?(this.clear(e),null):(t.lastAccess=n,t.value)},getLength:function(){return Object.getLength(this.data)},isFull:function(){return this.getLength()>=this.options.capcity},load:function(e,t){for(var n in e)e.hasOwnProperty(n)&&this.set(n,e[n])},clear:function(e){return e?delete this.data[e]:this.data={},this},calculateDuration:function(e){return e*1e3+Date.now()},purge:function(){var e=[],t=Date.now();Object.each(this.data,function(n,r){n.expires<=t?this.clear(r):e.push(n)}),e.sort(function(e,t){return t.lastAccessed-e.lastAccessed});while(e.length>this.options.capcity){var n=e.pop();this.clear(n.key)}}});(function(e){function l(){s.getStyle("display")!="none"&&!a&&(a=(new Element("div#loading_unit")).fade("hide").inject(s),(new Element("h1",{html:"页面加载中"})).inject(a),(new Element(".progress")).inject(a),(new Element("a.go",{html:"点此手动跳转",href:e.location.href})).inject(a),a.fade("in"))}var t=e.History;if(!t.enabled)return!1;t.unescapeString=function(e){return e};var n=100,r=app.$pageCache=new Cache({duration:900,capcity:Browser.ie?4:10}),i=app.scheme+"://"+app.host,s,o,u,a,f=null,c=function(e){if(!o){o=setTimeout(c,e);return}o=null,u||(u=new Fx.Tween(s,{duration:1e3})),s.show(),u.chain(function(){l.delay(1e3)}).set("opacity",0).start("opacity",1)},h=function(){o&&clearTimeout(o),o=null,u&&u.stop(),s.hide(),a&&(a.destroy(),a=null)},p=function(t){document.title="加载中...",c(100),(new Request.JSON({url:t,noCache:!0,onSuccess:function(e){if(e.err)return location.href=t;var n=Object.append({$url:t},e);d(n)},onFailure:function(){e.location.href=t}})).get()},d=function(t){h(),app.page.$waterfall&&app.page.$waterfall.detach(),app.page.$header&&app.page.$header.detach(),app.page.$navigator&&app.page.$navigator.detach(),app.page.isOrganizing&&app.page.isOrganizing.fireEvent("click"),app.page.msgCloseTimeout&&clearTimeout(app.page.msgCloseTimeout),app._currentSheet&&app.hideSheet(),app.page.dmController&&app.page.dmController.hide(),document.body.setStyle("overflow",""),app.view.dispose(),app.page.$view||(app.page.$waterfall&&app.page.$waterfall.destroy(),app.view.destroy()),app.page=t;if(t.$view)app.view=t.$view,app.view.inject(document.body,"top"),t.$waterfall&&t.$waterfall.attach(),t.$header&&t.$header.attach(),t.$navigator&&t.$navigator.attach(),app.setTitle();else{app.view=(new Element("div",{id:"page"})).inject(document.body,"top");var n=t.$url;app.route(n),app.setTitle()}t.$scroll&&e.scrollTo(t.$scroll.x,t.$scroll.y),app.fireEvent("switchPage",{url:t.$url})},v=function(i){if(t.savedStates.length>n){e.location.href=i;return}var s=r.get(i),o=t.getState();if(f&&f[o.id])return f[o.id](o);if(f&&f[i])return f[i](o);s?d(s):p(i)};app.addEvent("switchPage",function(t){e.ga&&e._trackPageview&&e._trackPageview(),app.pushToBaidu()});var m=!0,g=document.title;t.Adapter.bind(e,"statechange",function(){var e=t.getState(),n="/"+e.url.replace(i,"").replace(/^\//,""),r=new URI(n);m&&!document.title&&(document.title=g,m=!1);if(app.currentUrl==r.toString())return;return app.currentUrl=location.href,v(n)}),Object.append(app,{onRoute:function(){app.page.$waterfall&&(app.page.$view=app.view,r.set(app.page.$url,app.page)),app.setTitle(),e.scrollTo(0,0)},reload:function(){p(app.page.$url)},redraw:function(){var e=app.page;delete e.$view,d(e)},setTitle:function(e){return e=e||app.page.title||History.options.initialTitle,t.setTitle({title:e}),this},registerStateHandler:function(e,t){return f=f||{},f[e]=t,this},removeStateHandler:function(e){return f&&delete f[e],this},getState:function(e){return"undefined"==typeof e?t.getState():t.getStateByIndex(e)},replaceState:function(e,n,r){return r="/"+r.replace(i,"").replace(/^\//,""),t.replaceState(e,n,r),this},pushState:function(e,n,r){return r="/"+r.replace(i,"").replace(/^\//,""),t.pushState(e,n,r),this},popState:function(){return this.back()},go:function(e){return this.pushState(null,null,e)},back:function(){return t.back(),t.Adapter.trigger(e,"popstate"),this},forward:function(){return t.forward(),t.Adapter.trigger(e,"popstate"),this},setPinView:function(e){if(app.page.noPinViewLayer)return;var t=app.getState().id;if(!app.$pinViewState||app.$pinViewState.url!==app.page.$url)f=null,r.clear(),r.set(app.page.$url,app.page),app.$pinViewState={id:t,url:app.page.$url,states:[]};var n=function(e){var t=e.hash.match(/pins\/(\d+)\//),n=t&&t[1];app.$pinViewState.url==app.page.$url&&app.$pinViewState.id==e.id?(app.hidePinViewLayer(),app.fireEvent("switchPage")):app.$pinViewState.url==app.page.$url&&n?(c(100),app.showPinViewLayer(n,function(){h(),app.fireEvent("switchPage")})):r.get(app.$pinViewState.url)?d(r.get(app.$pinViewState.url)):p(e.hash)};app.registerStateHandler("/pins/"+e+"/",n),app.registerStateHandler(t,n)}}),e.addEvent("domready",function(){app._firstOnRoute||(app._firstOnRoute=!0,app.onRoute()),s=document.id("page_overlay");var t=Cookie.read("_is_qplus");$(document.body).addEvent("click:relay(a.x)",function(n){if(!app._csr||n.meta||n.control||n.shift||n.alt||n.event.button!==0||app.page.nox)return!0;var r=n.target;r.get("tag")!=="a"&&(r=r.getParent("a"));var i=r.get("href");i&&i.test(/^\/message\//)&&(app._prepath=location.pathname);if(i){if(Browser.isMobile)return!0;if(Browser.ie&&Browser.version<9&&!t){if(i.test(/^(https?:\/\/[a-z0-9-_\.]+)?\/pins\/\d+\/?/g)&&!r.hasClass("self")){n.stop();var s=e.open(i,"_blank");try{s.focus()}catch(n){}return!1}}else if(i.indexOf("/")===0&&app.getRouter(i)){if(r.hasClass("layer-view")){var o=i.match(/^\/pins\/(\d+)\//),u=o&&o[1];u&&app.setPinView(u)}return n.stop(),app.go(i),!1}}return!0})}),e.addEvent("scroll",function(){if(!app.page)return;try{var t=e.getScroll();app.page.$scroll=t}catch(n){}})})(window),Object.append(app,{showSheet:function(e,t){t=t||{};var n="dialog/sheet_"+e;if(this._currentSheet&&this._currentSheet.retrieve("sheet_id")==n)return this._currentSheet;var r=this[n];r||this.render(n,t,function(e,t){var i=(new Element("div")).set("html",t);r=this[n]=i.getFirst().hide().inject(this.view),r.store("sheet_id",n),e&&Browser.exec(e)}.bind(this)),this.hideSheet(),this._fixFlashLayer(),this._currentSheet=r;var i=this,s=function(){var e=app.page.$header?app.page.$header.element:document.id("header"),n=e&&e.getStyle("position")!="static"?e.getCoordinates():{bottom:0},s=r.setStyle("top",-1e3).show().getHeight();if(t.modal){var o=r.retrieve("sheet:overlay");o||(o=(new Element("div",{"class":"sheet-overlay"})).inject(r,"before"),r.store("sheet:overlay",o)),o.set("tween",{duration:"short"}).fade("hide").fade("in")}r.set("tween",{duration:"short"}).tween("top",n.bottom-s,n.bottom).get("tween").chain(function(){var e=r.retrieve("onShow");"function"==typeof e&&e.apply(i,Array.prototype.slice.call(arguments,1))})};s(),Browser.ie6&&docScroller.toTop();var o=document.getElement(".registration-tip");o&&o.fade("out");var u=document.getElement(".dialog-boxes");return u&&u.getStyle("display")=="block"&&r.setStyle("z-index",99999),r},hideSheet:function(e){this._fixFlashLayer(!0);var t=this._currentSheet;if(t){var n=this,r=app.page.$header?app.page.$header.element:document.id("header"),i=r?r.getCoordinates():{bottom:0},s=t.retrieve("sheet:overlay"),o=t.hasClass("destroy");return s&&s.set("tween",{duration:"short"}).fade("out").get("tween").chain(function(){s.hide(),o&&s.destroy()}),t.set("tween",{duration:"short"}).tween("top",i.bottom,i.bottom-t.getHeight()).get("tween").chain(function(){var r=t.retrieve("onHide");t.hide(),t.hasClass("destroy")&&(delete n[t.retrieve("sheet_id")],t.destroy()),delete n._currentSheet,"function"==typeof r&&r.apply(n,Array.prototype.slice.call(arguments,1));var i=[];"function"==typeof e?e():"undefined"!=typeof e&&i.push(e),app.fireEvent("hideSheet",i)}),!0}},_fixFlashLayer:function(e){var t=document.id("_huaban_FixFlashStyle");if(e)return t&&t.destroy();if(!t){var t=new Element("style",{id:"_huaban_FixFlashStyle"}),n="object, embed {visibility: hidden}";(document.getElement("head")||document.body).grab(t),Browser.ie?t.styleSheet.cssText=n:t.set("text",n)}},showDialog:function(e){this.hideDialog();var t="dialog/dialog_"+e;this[t]||this.render(t,function(e,n){var r=(new Element("div")).set("html",n),i=this[t]=r.getFirst().inject(this.view);i.store("dialog_id",t),e&&Browser.exec(e)}.bind(this)),this._fixFlashLayer(),this[t].show(),this._currentDialog=this[t];var n=this[t].retrieve("onShow");return"function"==typeof n&&n.apply(this,Array.prototype.slice.call(arguments,1)),this[t]},hideDialog:function(){this._fixFlashLayer(!0);var e=this._currentDialog;if(e)return e.hide(),e.hasClass("destroy")&&(delete this[e.retrieve("dialog_id")],e.destroy()),delete this._currentDialog,!0},renderDialogBox:function(e,t){app.dialogBoxes=app.dialogBoxes||{},app.dialogBoxes.currents=app.dialogBoxes.currents||[];var n=app.view.getChildren(".dialog-boxes")[0],r=this;n||(n=(new Element("div.dialog-boxes")).inject(app.view),n.addEvent("click:relay(.dialog-overlay, .close-btn)",function(e){r.hideDialogBox(),e.stop()})),n.show(),t&&app.dialogBoxes[e]&&(app.dialogBoxes[e].destroy(),delete app.dialogBoxes[e]);if(!app.dialogBoxes[e]){var i=app.renderSync("dialog_box/"+e,t||{});app.dialogBoxes[e]=Elements.from(i).inject(n),i.stripScripts(!0)}else app.dialogBoxes[e].show()},showDialogBox:function(e,t){return(t||!app.dialogBoxes||!app.dialogBoxes[e])&&this.renderDialogBox(e,t),app.dialogBoxes[e].show(),app.dialogBoxes.currents.push(e),app.dialogBoxes[e]},hideDialogBox:function(e){if(!app.dialogBoxes)return!1;if(!e&&!app.dialogBoxes.currents.length)return!1;if(!e)e=app.dialogBoxes.currents.pop();else{var t=app.dialogBoxes.currents.indexOf(e);~t&&app.dialogBoxes.currents.splice(t,1)}var n=!1,r=app.dialogBoxes[e];return r&&r.getStyle("display")!="none"&&(r.hide().fireEvent("hide"),n=!0),n},hideAllDialogBox:function(){if(!app.dialogBoxes||!app.dialogBoxes.currents.length)return!1;var e=!1,t=app.dialogBoxes.currents,n;for(var r=0;r<t.length;r++)n=app.dialogBoxes[t[r]],n.getStyle("display")!="none"&&(n.hide().fireEvent("hide"),e=!0);return app.dialogBoxes.currents=[],e},requireCaptcha:function(e){return app.$captcha_callback=e,app.showSheet("comment_captcha",{modal:!0}),!1},requireLogin:function(e,t){if(app.req.user)return e&&e(),!0;e?(Object.append(e,t||{redraw:!0}),app.$login_callback=e):t&&(app.$login_callback=t),app.loginFrame?app.loginFrame.inject(app.view):app.render("base/login_frame","",function(e,t){app.loginFrame=Elements.from(t)[0].inject(app.view),e&&Browser.exec(e)});var n=t&&t.to||"signup";return app.loginFrame.switchTo(n),!1},requireImportOldTags:function(e){var t=app.req.user;if(t&&t.status&&1!==t.status.old_tags)return e();var n=app.showDialogBox("import_old_tags");n.addEvent("confirm",e)},importTagsAndRefresh:function(e,t){var n=app.req.user;if(!e||!e.length)return t();if(n&&n.status&&1!==n.status.old_tags)return t();app.requireImportOldTags(function(){window.location.reload()})},scrollRequireLogin:function(e,t,n){var r=!0,i=function(i){0>=--e&&r&&(app.requireLogin(n,{to:"login"}),r=!1),0==--t&&(app.req.user||i.destroy(),app.requireLogin(n,{to:"login"}))};return{run:i}},showUploadDialog:function(){app.requireLogin(function(){app.showDialogBox("upload",!0)})},forceLogin:function(){return app.req.user?!0:(app.showSheet("login",{modal:!0}),!1)},msg:function(e,t){var n=Object.append({text:e,type:"success",timeout:3e3},t),r=document.id("floating_notice_box")||(new Element("#floating_notice_box")).inject(document.body,"top");return app.renderElements("base/floating_notice",n,r),this},error:function(e,t){typeof e!="object"&&(e={text:e});var n=Object.append({title:"错误",type:"error"},e);return app.alert(n,t)},alert:function(e,t){typeof e!="object"&&(e={text:e});var n=Object.append({text:"",title:"",type:"caution",action:"确定",cancelButton:!1,closeButton:!0},e),r=n.text.split("$$"),i=r.length?r[r.length-1]:"";~i.indexOf("captcha")?t=function(e){n.title="提示",(new Request.JSON({url:"/gt/validate/",method:"post",data:{key:i.substring(8),type:"limit",validate:e},onSuccess:function(){app.alert("验证成功，请继续完成后续操作")},onFailure:function(e){app.error(JSON.parse(e.response||"{}").error||app.COMMON_ERRMSG)}})).post()}:~i.indexOf("reset_email")&&(n.title="提示",n.action="发送邮件",t=function(){(new Request.JSON({url:"/password/reset/email/",data:{email:i.substring(12)},onSuccess:function(e){app.alert("重置密码的链接已被发送到你的邮箱"+(e.data.link?'，请 <a target="_blank" class="red-link" href="http://'+e.data.link+'">点击查收邮件</a>以重置密码。':""))},onFailure:function(e){app.error(JSON.parse(e.response||"{}").error||app.COMMON_ERRMSG)}})).post()});var s=app.showDialogBox("alert",n);return t&&s.addEvent("confirm",t),this},confirm:function(e,t){typeof e!="object"&&(e={text:e});var n=Object.append({cancelButton:!0},e);app.alert(n,t)},showTip:function(e,t,n){n=Object.append({arrow:"left"},n);var r=n.offset||{x:15,y:0},i=e.retrieve("hb:tip");i||(i=(new Element("div",{"class":"msgr"})).inject(e,"after"),i.set("html",'<span class="txt"></span><span class="arrow">◣</span><span class="arrow-mask"></span>'),e.store("hb:tip",i)),i.getElement("span.txt").set("html",t),n.arrow=="left"&&i.addClass("left-arrow"),n.width&&i.setStyle("width",n.width),i.position({relativeTo:e,position:"upperRight",edge:"upperLeft",offset:r}),i.show()},hideTip:function(e){var t=e.retrieve("hb:tip");if(!t)return;t.hide()},initGifButtons:function(){var e={buttonSelector:".gif-icon"};app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[e.buttonSelector])return;app.view.$initialized[e.buttonSelector]=!0,app.view.addEvent("click:relay("+e.buttonSelector+")",function(e){e.stop();var t=this,n=t.getSiblings("img"),r=t.getParent("a.img.layer-view"),i=t.getElement(".gif-loading"),s=n.get("src")[0];t.getSiblings(".cover").addClass("remove-cover");if(t.hasClass("gif-stop"))t.removeClass("gif-stop"),n.set("src",app.gifURL(s)),r.removeClass("gif");else{t.addClass("gif-load"),i.setStyle("display","inline-block");var o=app.gifURL(s),u=Asset.image(o,{onLoad:function(){n.set("src",o),r.addClass("gif"),t.removeClass("gif-load").addClass("gif-stop"),i.setStyle("display","none")}})}})},initFollowButtons:function(){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[".follow,.unfollow"])return;app.view.$initialized[".follow,.unfollow"]=!0,app.view.addEvent("click:relay(.follow,.unfollow)",function(e){function i(){t.hasClass("unfollow")?(r.setTitle("取消..."),(new Request.JSON({url:"/boards/"+n+"/unfollow/",onSuccess:function(e){if(e.err)return r.setTitle("已关注"),app.error(e.msg||app.COMMON_ERRMSG);t.removeClass("unfollow").addClass("follow"),r.setTitle("关注").enable()}})).post()):(r.setTitle("关注..."),(new Request.JSON({url:"/boards/"+n+"/follow/",onSuccess:function(e){if(e.err)return r.setTitle("关注"),app.error(e.msg||app.COMMON_ERRMSG);t.addClass("unfollow").removeClass("follow"),r.setTitle("已关注").enable()}})).post())}e.stop();var t=this,n=t.get("data-id"),r=(new Button(t)).disable();return app.req.user?i():(app.requireLogin(function(){t=app.view.getElement("a[data-id="+n+"].follow"),t?i():app.error("这个画板是你自己的")}),!1)})},initFollowExploreButtons:function(e){function n(e,t){(new Request.JSON({url:"/explore/"+e+"/follow/",onSuccess:t})).post()}function r(e,t){(new Request.JSON({url:"/explore/"+e+"/unfollow/",onSuccess:t})).post()}var t={buttonSelector:".follow-explore",unfollowButtonClass:"unfollow-explore",onFollowSuccess:function(){},onUnfollowSuccess:function(){}};Object.append(t,e),app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[t.buttonSelector])return;app.view.$initialized[t.buttonSelector]=!0,app.view.addEvent("click:relay("+t.buttonSelector+")",function(e){e.stop();var i=this,s=this.get("data-urlname");if(i.hasClass("disabled"))return;i.addClass("disabled"),app.requireLogin(function(){i.hasClass(t.unfollowButtonClass)?(i.addClass("unfollow-explore"),r(s,function(e){i.removeClass("disabled");if(e.err)return app.error(e.msg||"操作失败");i.removeClass(t.unfollowButtonClass),t.onUnfollowSuccess(i,e)})):n(s,function(e){i.removeClass("disabled");if(e.err)return app.error(e.msg||"操作失败");i.addClass(t.unfollowButtonClass),t.onFollowSuccess(i,e)})},{reload:!0})})},initPureFollowBoardButtons:function(e){function n(e,t){(new Request.JSON({url:"/boards/"+e+"/follow/",onSuccess:t})).post()}function r(e,t){(new Request.JSON({url:"/boards/"+e+"/unfollow/",onSuccess:t})).post()}var t={buttonSelector:".follow-board",unfollowButtonClass:"unfollow",onFollowSuccess:function(){},onUnfollowSuccess:function(){}};Object.append(t,e),app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[t.buttonSelector])return;app.view.$initialized[t.buttonSelector]=!0,app.view.addEvent("click:relay("+t.buttonSelector+")",function(e){e.stop();var i=this,s=this.get("data-id");if(i.hasClass("disabled"))return;i.addClass("disabled"),app.requireLogin(function(){i.hasClass(t.unfollowButtonClass)?(i.addClass("unfollowing"),r(s,function(e){i.removeClass("disabled unfollowing");if(e.err)return app.error(e.msg||"操作失败");i.removeClass(t.unfollowButtonClass),t.onUnfollowSuccess(i,e)})):(i.addClass("following"),n(s,function(e){i.removeClass("disabled following");if(e.err)return app.error(e.msg||"操作失败");i.addClass(t.unfollowButtonClass),t.onFollowSuccess(i,e)}))},{reload:!0})})},initFollowUserButtons:function(e){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized["a.followuser,a.unfollowuser"])return;app.view.$initialized["a.followuser,a.unfollowuser"]=!0,app.view.addEvent("click:relay(a.followuser,a.unfollowuser)",function(t){function s(){n.hasClass("unfollowuser")?(i.setTitle("Unfollowing..."),(new Request.JSON({url:"/"+r+"/unfollow/",onSuccess:function(t){if(t.err)return i.setTitle("取消关注"),app.error(t.msg||app.COMMON_ERRMSG);n.removeClass("unfollowuser").removeClass("wbtn").addClass("followuser").addClass("rbtn"),i.setTitle("关注").enable(),e&&e(n)}})).post()):(i.setTitle("Following..."),(new Request.JSON({url:"/"+r+"/follow/",onSuccess:function(t){if(t.err)return i.setTitle("关注"),app.error(t.msg||app.COMMON_ERRMSG);n.addClass("unfollowuser").removeClass("followuser").removeClass("rbtn").addClass("wbtn"),i.setTitle("取消关注").enable(),e&&e(n)}})).post())}var n=this,r=n.get("data-id"),i=(new Button(n)).disable();return app.req.user?s():(app.requireLogin(function(){n=app.view.getElement("a[data-id="+r+"].followuser"),n?s():app.error("这就是你自己")}),!1)})},initPureFollowUserButtons:function(e){function n(e,t){(new Request.JSON({url:"/"+e+"/follow/",onSuccess:t})).post()}function r(e,t){(new Request.JSON({url:"/"+e+"/unfollow/",onSuccess:t})).post()}var t={buttonSelector:".followuser",unfollowButtonClass:"unfollowuser",onFollowSuccess:function(){},onUnfollowSuccess:function(){}};Object.append(t,e),app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[t.buttonSelector])return;app.view.$initialized[t.buttonSelector]=!0,app.view.addEvent("click:relay("+t.buttonSelector+")",function(){var e=this,i=this.get("data-urlname");if(e.hasClass("disabled"))return;e.addClass("disabled"),app.requireLogin(function(){e.hasClass(t.unfollowButtonClass)?(e.addClass("unfollowing"),r(i,function(n){e.removeClass("disabled unfollowing");if(n.err)return app.error(n.msg||"操作失败");e.removeClass(t.unfollowButtonClass),t.onUnfollowSuccess(e,n)})):(e.addClass("following"),n(i,function(n){e.removeClass("disabled following");if(n.err)return app.error(n.msg||"操作失败");e.addClass(t.unfollowButtonClass),t.onFollowSuccess(e,n)}))},{reload:!0})})},initPureLikeButtons:function(e){function n(e,t){(new Request.JSON({url:"/pins/"+e+"/like/",onSuccess:t})).post()}function r(e,t){(new Request.JSON({url:"/pins/"+e+"/unlike/",onSuccess:t})).post()}var t={buttonSelector:".laud-btn",unLikeButtonClass:"cancel",onLikeSuccess:function(){},onUnLikeSuccess:function(){}};Object.append(t,e),app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[t.buttonSelector])return;app.view.$initialized[t.buttonSelector]=!0,app.view.addEvent("click:relay("+t.buttonSelector+")",function(){var e=this,i=this.get("data-id");if(e.hasClass("disabled"))return;e.addClass("disabled"),app.requireLogin(function(){e.hasClass(t.unLikeButtonClass)?r(i,function(n){e.removeClass("disabled");if(n.err)return app.error(n.msg||"操作失败");e.removeClass(t.unLikeButtonClass),t.onUnLikeSuccess(e,n)}):n(i,function(n){e.removeClass("disabled");if(n.err)return app.error(n.msg||"操作失败");e.addClass(t.unLikeButtonClass),t.onLikeSuccess(e,n)})},{reload:!0})})},initLikeButtons:function(){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized["a.like,a.unlike"])return;app.view.$initialized["a.like,a.unlike"]=!0,app.view.addEvent("click:relay(a.like,a.unlike)",function(e){function s(){var e=(new Button(t)).disable(),s=r?e.element.getElement(".text").get("text"):e.element.get("text"),o=s.toInt(),u="赞",a=e.getTitle();~a.indexOf("喜欢")&&(u="喜欢"),o=isNaN(o)?0:o,t.hasClass("unlike")?(e.setTitle("Unliking..."),(new Request.JSON({url:"/pins/"+n+"/unlike/",onSuccess:function(n){t.removeClass("unlike").addClass("like"),o--;var r=o>0?o+u:u;e.setTitle(r).enable(),i&&i.removeClass("liked").innerHTML--}})).post()):(e.setTitle("Liking..."),(new Request.JSON({url:"/pins/"+n+"/like/",onSuccess:function(n){t.addClass("unlike").removeClass("like"),o++,e.setTitle(o+u).enable(),i&&i.addClass("liked").innerHTML++}})).post())}var t=this,n=t.get("data-id"),r=this.getParent(".pin");if(r)var i=r.getElement(".commodity .likes");return app.req.user?s():(app.requireLogin(function(){t=app.view.getElement("a[data-id="+n+"].like"),t?s():app.error("这个采集是你自己的")}),!1)})},initDelCommentButtons:function(){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[".pin-view .info-piece .comments .delete"])return;app.view.$initialized[".pin-view .info-piece .comments .delete"]=!0,app.view.addEvent("click:relay(.pin-view .info-piece .comments .delete)",function(e){if(!app.forceLogin())return;var t=e.target;t.get("tag")!=="a"&&(t=t.getParent("a"));var n=t.get("data-url");return(new Request.JSON({url:n,data:{_method:"DELETE"},onSuccess:function(e){if(e.err)return app.error(e.msg||app.COMMON_ERRMSG);var n=t.getParent("div.comment");n&&n.tween("opacity",0).get("tween").chain(function(){n.destroy()})}})).post(),!1})},initReplyButtons:function(){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized[".pin-view .comments .reply-button"])return;app.view.$initialized[".pin-view .comments .reply-button"]=!0,app.view.addEvent("click:relay(.pin-view .comments .reply-button)",function(){var e=this.get("data-name"),t=document.getElement("#pin_view_add_comment textarea");~t.value.indexOf(e)||(t.value="@"+e+" "+t.value),t.setCaretPosition("end").fireEvent("keyup")})},initShowMoreButtons:function(){app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized["a.show-more"])return;app.view.$initialized["a.show-more"]=!0,app.view.addEvent("click:relay(a.show-more)",function(e){var t=this.getParent("p.description"),n=app.page.$waterfall,r=this.getParent(".pin"),i=this.getParent(".waterfall");i&&i.$waterfall&&(n=i.$waterfall);if(t&&n&&r){var s=t.get("data-raw");t.set("html",s),n.update(r)}})},initAddCommentButtons:function(){function e(e){var t=e.getParent("div.pin"),n=app.page.$waterfall,r=e.getParent(".waterfall");r&&r.$waterfall&&(n=r.$waterfall);if(e.hasClass("ani-affected"))return;e.addEvents({focus:function(){this.getParent(".write").addClass("focus"),n&&n.update(t)},blur:function(){this.value||this.getParent(".write").removeClass("focus"),n&&n.update(t)}}).addClass("ani-affected"),window.document.activeElement==e&&e.fireEvent("focus")}function t(e){if(e.retrieve("registered-at"))return;new Autocompleter.Contacts.At(e,{width:154,delay:300})}function n(){function f(){(new Request.JSON({url:u,data:{text:o},onSuccess:function(r){function u(e){n.hide(),i.set("value","");var r=app.renderSync("base/comment_item_convo",e.comment),o=Elements.from(r).inject(s);s.isDisplayed()||s.show(),o.highlight("#EEE");var u=app.page.$waterfall;u&&u.update(t)}r.err&&r.err==412?(app.$form={pinId:a,text:o},app.requireCaptcha(u)):r.err?app.error(r.msg||app.COMMON_ERRMSG):u(r),e.removeClass("disabled")},onFailure:function(){app.error(app.COMMON_ERRMSG),e.removeClass("disabled")}})).post()}var e=this;if(e.hasClass("disabled"))return!1;var t=e.getParent("div.pin"),n=t.getElement("div.write"),r=n.getElement("form"),i=r.getElement("textarea"),s=n.getPrevious("div.comments"),o=i.get("value").trim();if(o==""||o=="说说你的看法或@给好友")return i.highlight(),!1;var u=r.get("action"),a=t.get("data-id");return e.addClass("disabled"),app.req.user?f():(app.requireLogin(function(){t=app.view.getElement("div[data-id="+a+"].pin");if(!t)return app.error("你不能评论这个采集");e=t.getElement("a.grid_comment_button"),n=t.getElement("div.write"),r=n.getElement("form"),i=r.getElement("textarea"),s=n.getPrevious("div.comments"),n.show(),i.set("value",o),f()}),!1)}app.view.$initialized=app.view.$initialized||{};if(app.view.$initialized["textarea.GridComment,a.comment,a.replyButton,.grid_comment_button"])return;app.view.$initialized["textarea.GridComment,a.comment,a.replyButton,.grid_comment_button"]=!0,app.view.addEvent("click:relay(textarea.GridComment)",function(){e(this),t(this)}),app.view.addEvent("click:relay(a.comment,a.replyButton)",function(){var n=this,r=n.getParent("div.pin"),i=r.getElement("div.write"),s=i.getElement("textarea"),o=app.page.$waterfall,u=this.getParent(".waterfall");u&&u.$waterfall&&(o=u.$waterfall),e(s),t(s);if(n.hasClass("disabled"))i.hide(),o&&o.update(r),n.removeClass("disabled");else{i.show(),o&&o.update(r),docScroller.chain(function(){try{s.focus()}catch(e){}s.highlight()}),r.getSize().y>document.html.clientHeight?docScroller.toElementCenter(s,"y"):docScroller.toElement(r,"y");if(n.hasClass("replyButton")){if(n.getParent(".attribution"))return!1;var a=n.getSiblings(".content")[0].getElement(".author").innerHTML;s.value==s.get("placeholder")&&(s.value=""),~s.value.indexOf(a)||(s.value="@"+a+" "+s.value,s.setCaretPosition("end").fireEvent("keyup"))}else n.addClass("disabled")}return!1}),app.view.addEvent("click:relay(.grid_comment_button)",n)},initSearchForms:function(e,t){document.getElements(e).each(function(e){if(!e)return;if(e.getAttribute("data-regestered"))return;e.setAttribute("data-regestered","regestered");var n=e.getElement("a.go"),r=e.getElement("input[name=q]"),i=r.get("placeholder");i&&!Modernizr.input.placeholder&&new Form.Placeholder(r,{color:t&&t.placeholderColor});var s=function(){return r.get("value")?!0:(e.getAttribute("class")=="new-searching-unit"&&r.set("placeholder","请输入你喜欢的关键词"),!1)};e.addEvent("submit",function(){return s()?!0:!1}),n&&n.addEvent("click",function(t){t.stop();if(!s())return;e.submit()});var o="",u=null,a=function(e){var n=r.value.replace(/^\s+|$/g,"");u&&u.isRunning()&&u.cancel();if(n==o)return;o=n,n?u=(new Request.JSON({url:"/search/hint/",data:{q:n,limit:t&&t.hintLimit||6},onSuccess:function(e){if(e.err)return f.empty();var i=e.result.filter(function(e){return e!=n}),s=app.renderSync("base/search_hint",{result:i}),o=r.getPosition().x-r.getParent().getParent().getPosition().x;f.innerHTML=s,f.setStyles({"min-width":r.getSize().x,left:o}),t&&t.queryHintCallback&&t.queryHintCallback(i)}})).get():(f.empty(),t&&t.queryHintCallback&&t.queryHintCallback([]))},f=new Element("div.search-hint");f.inject(e,"after"),r.set("autocomplete","off");var l=function(e){if(!f.getElements("li").length)return;var t=f.getElement(".active");if(t){var n=e=="next"?t.getNext("li"):t.getPrevious("li");n?(n.addClass("active"),t.removeClass("active")):(t.removeClass("active"),f.getElement(e=="next"?"li:first-child":"li:last-child").addClass("active"))}else f.getElement(e=="next"?"li:first-child":"li:last-child").addClass("active")};r.addEvents({keyup:a,click:a,keydown:function(e){if(e.key=="down"||e.key=="up")return l(e.key=="down"?"next":"prev"),!1;if(!(!e.control||e.key!="n"&&e.key!="p"))return l(e.key=="n"?"next":"prev"),!1;if(e.key=="tab"){var t=f.getElement(".active")||f.getElement("li");return t&&(r.value=t.innerHTML),!1}if(e.key=="enter"){var n=f.getElement(".active");if(n)return n.click(),!1}}}),$(document.body).addEvent("click",function(e){e.target.getParent(".search-hint")||f.empty()}),f.addEvent("click:relay(li)",function(){r.value=this.innerHTML,f.empty(),n&&n.click()}),f.addEvent("mouseenter:relay(li)",function(){this.addClass("active"),this.getSiblings().removeClass("active")})})},_gaq_promotion:function(){return;var e,t,n,r,i,s}});var Button=new Class({Implements:[Options,Class.Occlude],options:{},property:"Button",initialize:function(e,t){this.element=document.id(e);if(this.occlude())return this.occluded;this.setOptions(t),this.label=this.element.getElement("strong, span.text")||this.element,this.label&&(this.title=this.label.get("text")),this.action=this.options.click?this.options.click.bind(this):!1,delete this.options.click,this.attach(),this.element.hasClass("disabled")&&this.disable(),this.icon=this.element.getElement("i,em")},destroy:function(){this.element.destroy()},setTitle:function(e){e=e||this.title,this.label.empty();var t=this.icon&&!~e.toLowerCase().indexOf("<em")&&!~e.toLowerCase().indexOf("<i");return t&&this.icon.inject(this.label,"before"),this.label.appendText(e),this},getTitle:function(){return this.label.innerHTML},show:function(){this.element.show()},hide:function(){this.element.hide()},attach:function(){return this.action&&this.element.addEvent("click",this.action),this._disabled=!1,this},detach:function(){return this.action&&this.element.removeEvent("click",this.action),this._disabled=!0,this},disable:function(){return this._disabled?this:(this.detach(),this.element.addClass("disabled"),this.options.disabledTitle&&this.setTitle(this.options.disabledTitle),this)},enable:function(){return this._disabled===!1?this:(this.attach(),this.element.removeClass("disabled"),this.options.disabledTitle&&this.setTitle(this.title),this)},bind:function(e){var t=instanceOf(e,FancyInput)?e:e.retrieve("FancyInput");return t&&t.addEvents({feed:this.enable.bind(this),hunger:this.disable.bind(this)}),this}});(function(){if(Modernizr.input.placeholder)return;this.Form||(this.Form={}),this.Form.Placeholder=new Class({Implements:Options,options:{color:"#A9A9A9",clearOnSubmit:!0},initialize:function(e,t){this.setOptions(t),this.element=document.id(e),this.placeholder=this.element.get("placeholder"),this.original_color=this.element.getStyle("color"),this.is_password=this.element.get("type")=="password"?!0:!1,this.activatePlaceholder(),this.element.addEvents({focus:function(){this.deactivatePlaceholder()}.bind(this),blur:function(){this.activatePlaceholder()}.bind(this)}),this.element.getParent("form")&&this.options.clearOnSubmit&&this.element.getParent("form").addEvent("submit",function(e){this.element.get("value")==this.placeholder&&this.element.set("value","")}.bind(this))},activatePlaceholder:function(){if(this.element.get("value")==""||this.element.get("value")==this.placeholder)this.is_password&&this.element.set("type","text"),this.element.setStyle("color",this.options.color),this.element.set("value",this.placeholder)},deactivatePlaceholder:function(){this.element.get("value")==this.placeholder&&(this.is_password&&this.element.set("type","password"),this.element.set("value",""),this.element.setStyle("color",this.original_color))}})})();var FancyInput=new Class({Binds:["_checker"],Implements:[Events,Options,Class.Occlude],options:{},property:"FancyInput",initialize:function(e,t){this.element=document.id(e);if(this.occlude())return this.occluded;this.setOptions(t),this.label=this.element.getNext("label"),this.placeholder=this.element.get("placeholder"),!this.label&&this.placeholder&&!Modernizr.input.placeholder&&new Form.Placeholder(this.element);if(Browser.ie&&this.label){if(Browser.ie6){var e=this.label.getNext("span.fff");e&&e.dispose()}this.label.addEvent("click",function(){this.element.focus()}.bind(this))}this.attach()},attach:function(){this._timer=null,this.element.addEvents({keyup:this._checker,focus:function(){this._timer=this._checker.periodical(500),this.fireEvent("focus",this)}.bind(this),blur:function(){this._timer&&clearTimeout(this._timer),this.fireEvent("blur",this)}.bind(this)}),this._checker()},setValue:function(e){this.element.set("value",e),this._checker()},getValue:function(){return this.element.get("value")},_checker:function(){this.element.get("value")!=""?(this.label&&this.label.hide(),this.fireEvent("feed")):(this.label&&this.label.show(),this.fireEvent("hunger"))}}),PopupPicker=new Class({Implements:[Events,Options],Binds:["attach","show","bodyClicked"],options:{},initialize:function(e,t,n){this.setOptions(n),this.element=document.id(e),this.popup=document.id(t),this.attach(),this.popup.addEvent("click:relay(li)",function(e){var t=e.target;t.get("tag")!="li"&&(t=t.getParent()),this.fireEvent("pick",t),this.hide()}.bind(this))},attach:function(){this.element.addEvent("click",this.show)},detach:function(){this.element.removeEvent("click",this.show)},show:function(){this.detach(),this.popup.show(),document.body.addEvent("click",this.bodyClicked),this.fireEvent("show")},hide:function(){this.popup.hide(),document.body.removeEvent("click",this.bodyClicked),this.attach.delay(100),this.fireEvent("hide")},bodyClicked:function(e){this.popup.isDisplayed()&&!this.popup.mouseOver(e.page)&&this.hide()}}),CategoryPicker=new Class({Implements:[Class.Occlude,Events,Options],Binds:["select"],property:"CategoryPicker",options:{showAll:!1,itemHeight:30,maxVisibleItems:8,setHeight:!1},initialize:function(e,t){this.element=document.id(e);if(this.occlude())return this.occluded;this.setOptions(t),this.init()},init:function(){var e=this.element;this._maxH=this.options.itemHeight*this.options.maxVisibleItems,this.curEl=e.getElement(".CurrentBoard"),this.popEl=e.getElement(".BoardList"),this.bodyEl=e.getElement(".BoardListBody"),this.listEl=this.bodyEl.getElement("ul"),this.popup=new PopupPicker(e,this.popEl,{onPick:this.select.bind(this)}),this.build()},build:function(){this._empty(),app.settings.categories.each(function(e){if(e.id=="videos"||e.id=="web_captures"||e.id=="taomm"||!this.options.showAll&&e.selectable===!1)return;this._injectItem(e.id,e.name)},this)},_empty:function(){this._items=0,this.listEl.empty()},_injectItem:function(e,t){this._items+=1;var n=(new Element("li",{"class":"BoardCategory",data:e,html:"<span>"+t+"</span>"})).inject(this.listEl);if(this.options.setHeight){var r=this._items*this.options.itemHeight;this.bodyEl.setStyle("height",r>this._maxH?this._maxH:r)}return n},select:function(e){if(!e)return;if(typeOf(e)==="element")return this.curEl.set("data",e.get("data")).set("html",e.getElement("span").get("html")),this.fireEvent("select"),this;var t=this.listEl.getElements("li");for(var n=0,r=t.length;n<r;n++)if(t[n].get("data")==e)return this.select(t[n]);return this},hide:function(){this.popup.hide()},getSelected:function(){return this.curEl.get("data")}}),BoardPicker=new Class({Extends:CategoryPicker,options:{setHeight:!0,currentBoard:!1},init:function(){this.parent(),(new Request.JSON({url:"/last_boards/",data:{extra:"recommend_tags"},noCache:!0,onSuccess:function(e){if(e.err)this.curEl.set("html",e.msg);else{var t=e.boards.filter(function(e){return e.is_private!=2});app.req.user.boards=t,this.build()}}.bind(this),onFailure:function(){this.curEl.set("html",app.COMMON_ERRMSG)}.bind(this)})).get()},add:function(e){app.req.user.boards.push(e);var t=this._injectItem(e.board_id,e.title);return this.select(t),this},build:function(){if(!app.req.user.boards)return;var e=app.req.user.boards;if(!e||e.length===0)return;this._empty(),e.each(function(e){this._injectItem(e.board_id,e.title)},this),this.select(this.options.currentBoard||this.listEl.getFirst("li"))}}),MusePicker=new Class({Implements:[Events,Options],options:{},initialize:function(e,t){this.setOptions(t),this.mainEl=document.id(e),this.init();var n=this.mainEl.get("data").split(",");return this.appendItems(n),this},init:function(){this.inputEl=this.mainEl.getElement(".input.area"),this.menuEl=this.mainEl.getElement(".select.menu"),this.textEl=this.inputEl.getElement(".text"),this.popupEl=new PopupPicker(this.mainEl,this.menuEl,{onPick:this.select.bind(this)}),this.initMenu(),this.attach()},initMenu:function(){var e=this;e.menuEl.empty(),e.categories=app.settings.muse_categories,e.categories.each(function(t){var n=new Element("li",{"class":"item",data:t.id,text:t.name});n.inject(e.menuEl)})},attach:function(){var e=this;e.inputEl.addEvent("click",function(t){var n=t.target;if(n.hasClass("remove")){var r=n.getParent(),i=r.get("data");e.removeItems(i)}window.setTimeout(e.popupEl.show)})},select:function(e){if(!e)return;var t=e.get("data");return this.appendItems(t)},appendItems:function(e){e=[].concat(e);var t=this,n=this.menuEl.getElements(".item").filter(function(e){return e.getStyle("display")!=="none"});return e.each(function(e){var r=t.categories.filter(function(t){return t.id===e});if(!r.length)return;var i=n.filter(function(t){return t.get("data")===e});if(!i.length)return;i[0].hide();var s=r[0].name,o=new Element("span",{"class":"label",data:e,html:s+'<i class="remove"></i>'});o.inject(t.inputEl)}),this.inputEl.getElements(".label").length&&t.textEl.hide(),this.reposition(),this.refreshData()},removeItems:function(e){e=[].concat(e);var t=this,n=this.menuEl.getElements(".item").filter(function(e){return e.getStyle("display")==="none"}),r=this.inputEl.getElements(".label");return e.each(function(e){var i=t.categories.filter(function(t){return e===t.id});if(!i.length)return;var s=n.filter(function(t){return t.get("data")===e});if(!s.length)return;s[0].show(),r.each(function(t){t.get("data")===e&&t.remove()})}),this.inputEl.getElements(".label").length||this.textEl.show(),this.reposition(),this.refreshData()},getSelected:function(){var e=this.inputEl.getElements(".label"),t=e.map(function(e){return e.get("data")});return t},reposition:function(){var e=this.inputEl.getSize();10<e.y&&this.menuEl.setStyle("top",e.y)},refreshData:function(){var e=this.inputEl.getElements(".label"),t=e.map(function(e){return e.get("data")});return this.mainEl.set("data",t),this}}),BoardList=new Class({Implements:[Events,Options],options:{boardCreatable:!0,creationAll:!1},initialize:function(e,t){this.setOptions(t);var n=this;this.mainEl=e,this.listEl=e.getElement(".drop-list"),this.currentEl=e.getElement(".current"),this.filterInput=e.getElement(".filter input"),this.boardsEl=this.listEl.getElement(".boards"),this.filtrateEl=this.listEl.getElement(".filtrate"),this.filterValue="",app.page.$creation&&(this.options.creationOnly=!0),this.currentEl.addEvent("click",function(){n.openList()}),e.addEvent("click:relay(.selections .board)",function(){n.selectBoard(this.get("data-board-id"))}),this.filterInput.addEvent("keyup",function(){n.filterValue!==this.value&&(n.checkFilter(this.value),n.filterValue=this.value)}),$(document.html).addEvent("click",this.clickingOtherArea.bind(this)),e.addEvent("click:relay(.create-board)",function(){n.createBoard(this.get("data-name"))}),e.addEvent("submit",this.onSubmit.bind(this)),this.keyboard=new Keyboard({defaultEventType:"keydown",events:{up:function(e){n.preSelectTo("prev"),e.stop()},down:function(e){n.preSelectTo("next"),e.stop()},"ctrl+p":function(e){n.preSelectTo("prev"),e.stop()},"ctrl+n":function(e){n.preSelectTo("next"),e.stop()},enter:function(e){var t=n.mainEl.getElement(".board.selected");t&&(t.click(),e.stop())},esc:function(e){n.filterValue?n.emptyFilter():n.closeList()}}}),app.req.user.boards?(n.boards=app.req.user.boards,n.handleBoards()):(new Request.JSON({url:"/last_boards/",noCache:!0,data:{extra:"recommend_tags"},onSuccess:function(e){if(e.err)return alert(e.err);var t=e.boards.filter(function(e){return e.is_private!=2});n.boards=t,app.req.user.boards=t,n.handleBoards()},onFailure:function(){alert(app.COMMON_ERRMSG)}})).get()},handleBoards:function(){var e=this;e.loadPinyinLib(function(){var t=e.filterCategories(e.boards);e.director=new FormatBoardList(t),e.groupedBoards=e.director.formatJson(),e.buildList();var n=e.mainEl.getElement(".board");n&&e.mainEl.hasClass("use-default-board")&&e.selectBoard(n.get("data-board-id"))})},filterCategories:function(e){var t=this.options&&this.options.creationOnly,n=e;this.options.creationAll||(n=e.filter(function(e){var n=e&&e.extra&&e.extra.is_creation;return t?n:!n}));var r=this.mainEl.get("data-categorys");if(r){var i=r.split(","),e=n.filter(function(e){return~i.indexOf(e.category_id)});return!e||!e.length?(this.fireEvent("noboard"),[]):e}return n},showCreationBoards:function(e){this.options.creationOnly=!0,this.handleBoards(),e&&e()},loadPinyinLib:function(e){if(typeof Pinyin!="undefined")return e();new Asset.javascript("/js/pinyin.js",{onLoad:e})},buildList:function(){this.boardsEl.empty();var e=app.renderSync("base/board_list_cell",this.groupedBoards);Elements.from(e).inject(this.boardsEl)},openList:function(){this.listEl.show(),this.filterInput.focus(),this.keyboard.activate(),this.isShowing=!0,this.clearPreSelect()},closeList:function(){this.listEl.hide(),this.keyboard.deactivate(),app.hotkey&&app.hotkey.keyboard.activate(),this.isShowing=!1},clickingOtherArea:function(e){this.isShowing&&!e.target.getParent(".board-list")&&this.closeList()},selectBoard:function(e){this.mainEl.set("data-board-id",e);var t=this.mainEl.getElement(".selections a[data-board-id="+e+"]");t&&this.mainEl.set("data-select-category",t.get("data-category")),t&&(this.currentEl.getElement(".name").innerHTML=t.innerHTML),this.emptyFilter(),this.closeList(),this.fireEvent("select"),this.mainEl.fireEvent("select")},showFiltrate:function(){this.boardsEl.hide(),this.filtrateEl.show()},hideFiltrate:function(){this.boardsEl.show(),this.filtrateEl.hide()},emptyFiltrate:function(){this.filtrateEl.empty()},checkFilter:function(e){if(!e)return this.hideFiltrate(),[];if(!this.director)return[];this.showFiltrate(),this.emptyFiltrate();var t=this.director.match(e),n=app.renderSync("base/board_list_filtrate",{boards:t,name:e,boardCreatable:this.options.boardCreatable});Elements.from(n).inject(this.filtrateEl);var r=this.filtrateEl.getElement(".board:not(.create-board)");r?this.preSelectBoardEl(r):this.preSelectBoardEl(this.filtrateEl.getElement(".create-board"))},emptyFilter:function(){this.filterInput.value="",this.checkFilter("")},createBoard:function(e){if(!e)return;var t=this.options&&this.options.creationOnly;(new Request.JSON({url:"/boards/",data:{title:e,creation:t},onSuccess:function(e){if(e.err)return app.error(e.msg||app.COMMON_ERRMSG);this.addBoard(e.board)}.bind(this),onFailure:function(){alert(app.COMMON_ERRMSG)},onComplete:function(){}})).post()},addBoard:function(e){this.boards.unshift(e);var t=this.filterCategories(this.boards);this.director.update(t),this.groupedBoards=this.director.formatJson(),this.buildList(),this.selectBoard(e.board_id)},preSelectBoardEl:function(e){if(!e)return;this.clearPreSelect(),e.addClass("selected");var t=e.getParent(".boards, .filtrate"),n=e.getPosition(t).y;n<0?t.scrollTo(0,n+t.getScroll().y):n>180&&t.scrollTo(0,n-180+t.getScroll().y)},clearPreSelect:function(){this.mainEl.getElements(".board.selected").removeClass("selected")},preSelectTo:function(e){if(this.boardsEl.getStyle("display")=="none")var t=this.filtrateEl;else if(this.filtrateEl.getStyle("display")=="none")var t=this.boardsEl;var n=t.getElements(".board"),r=t.getElement(".board.selected");if(!r)return this.preSelectBoardEl(n[0]);selectedId=r.get("data-board-id");for(var i=0;i<n.length;i++){var s=!1;e==="prev"?s=n[i-1]:e==="next"&&(s=n[i+1]),n[i].get("data-board-id")===selectedId&&s&&this.preSelectBoardEl(s)}},getSelected:function(){return this.mainEl.get("data-board-id")},onSubmit:function(){var e=this.getSelected(),t=null;this.boards=this.boards.filter(function(n){return n.board_id==e?(t=n,!1):!0}),this.boards.unshift(t),app.req.user.boards=this.boards}}),ImagePicker=new Class({Implements:[Events,Options,Class.Occlude],options:{cellW:170,minW:16,minH:16},property:"ImagePicker",initialize:function(e,t){this.element=document.id(e);if(this.occlude())return this.occluded;this.setOptions(t),this.listEl=this.element.getElement(".carousel-list"),this.arrowEl=this.element.getElement(".Arrows"),this.loadEl=this.element.getElement(".load"),this.attach()},attach:function(){var e=!0;this.listEl.get("tween").addEvents({start:function(){e=!1},complete:function(){e=!0}}),this.arrowEl.getElements("a.picker").addEvent("click",function(t){var n=this.listEl.getStyle("left").toInt(),r=this.listEl.getStyle("width").toInt();return t.target.hasClass("imagePickerNext")&&n>this.options.cellW-r?e&&this.listEl.tween("left",n,n-this.options.cellW):t.target.hasClass("imagePickerPrevious")&&n<0&&e&&this.listEl.tween("left",n,n+this.options.cellW),!1}.bind(this));var t=this.listEl;this.listEl.addEvent("click:relay(li)",function(){t.getElements("li").removeClass("selected"),this.addClass("selected")})},load:function(e,t,n,r){if(this.loading)return;typeOf(n)=="function"&&(r=n,n=!0),n=n===undefined?!0:!!n;if(e.length==0)return;this.loading=!0,this.loadEl.show(),this.fireEvent("startLoading");var i=new Asset.images(e,{onComplete:function(){this.loadEl.hide(),this.loading=!1,n&&(i=i.filter(function(e){return e.width===""||e.height===""||e.width.toInt()>=this.options.minW&&e.height.toInt()>=this.options.minH}.bind(this))),typeOf(r)=="function"&&r(i),this.build(i,t),this.fireEvent("finishLoading")}.bind(this)});return i},build:function(e,t){this.source=t,this.listEl.set("tween",{duration:"short"}).setStyles({width:e.length*this.options.cellW,left:0}).empty(),e.each(function(e){if(e.height*170/e.width>170){var t=new Element("li",{"class":"carousel-item long"}),n=new Element("span",{"class":"stop"}),r=new Element("span",{"class":"carousel-shadow"});e.inject(t),r.inject(t),n.inject(t),t.inject(this.listEl)}else{var i=new Element("li",{"class":"carousel-item"});e.addClass("short");var r=new Element("span",{"class":"carousel-shadow"});r.inject(i),e.inject(i),i.inject(this.listEl)}e.set("width",this.options.cellW).erase("height")},this);if(e.length>1){this.arrowEl.show(),this.element.getParent(".pbt").addClass("multi");var n=this.element.getParent(".modal");n&&n.setStyle("margin-top","-300px")}else this.arrowEl.hide(),this.element.getParent(".pbt").removeClass("multi")},insertImageElement:function(e,t,n){n.width>=n.height?n.set("width",this.options.cellW).erase("height"):n.set("height",this.options.cellW).erase("width"),n.inject((new Element("li",{"class":"carousel-item"})).inject(this.listEl))},assetComplate:function(){this.loadEl.hide(),this.loading=!1,this.fireEvent("finishLoading")},getSelected:function(){var e=this.listEl.getElement(".selected");if(e)var t=e.getElement("img");else var n=0-this.listEl.getStyle("left").toInt()/this.options.cellW,t=this.listEl.getElements("li img")[n];return{el:t,src:t.src,link:this.source}}}),SendSMSButton=new Class({Implements:[Events,Options,Class.Occlude],property:"SMSBindButton",options:{seconds:60,reason:""},initialize:function(e,t){"string"==typeof e?this.btnEl=document.id(e):this.btnEl=e,this.timer=null,this._lastTel=null,this._step=0,this.setOptions(t),this.attach()},attach:function(){var e=this;this.btnEl.addEvent("click",function(){e.fireEvent("click")})},sendSMS:function(e,t){var n=this;n._lastTel=e;var r={};n.options.reason&&(r.reason=n.options.reason),app.sendSMSTo(e,r,function(e){n.afterSendSMS(),t&&t(e)})},afterSendSMS:function(){this.startTimer()},resend:function(e){this.sendSMS(this._lastTel,e)},startTimer:function(){this.clearTimer(),this.btnEl.addClass("disabled");var e=this;this.timer=setInterval(function(){var t=e.options.seconds-e._step;e.btnEl.text="重新发送("+t+")",++e._step,0>=t&&e.clearTimer()},1e3)},clearTimer:function(){clearInterval(this.timer),this._step=0,this.btnEl.removeClass("disabled"),this.btnEl.set("text","重新发送")}}),TimerBtn=new Class({Implements:[Events,Options,Class.Occlude],property:"TimerBtn",options:{seconds:60},initialize:function(e,t){"string"==typeof e?this.btnEl=document.id(e):this.btnEl=e,this.timer=null,this._lastTel=null,this._step=0,this.setOptions(t),this.attach()},attach:function(){var e=this;this.btnEl.addEvent("click",function(){console.log("click",e.timer),e.timer||(e.fireEvent("click"),e.startTimer())})},startTimer:function(){this.clearTimer(),this.btnEl.addClass("disabled");var e=this;this.timer=setInterval(function(){var t=e.options.seconds-e._step;e.btnEl.text="重新发送("+t+")",++e._step,0>=t&&e.clearTimer()},1e3)},clearTimer:function(){clearInterval(this.timer),this.timer=null,this._step=0,this.btnEl.removeClass("disabled"),this.btnEl.set("text","重新发送")}});app.joinUrl=function(e,t){function n(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}return e.contains("?")?[e,"&",n(t)].join(""):[e,"?",n(t)].join("")},app.createCellLoader=function(e,t,n,r,i){function a(e,t){var n;return i&&i.template=="base/person_item"?n=app.renderSync(i.template,{user:e,pins:e.pins,req:app.req}):i&&i.template=="base/pin_view_board_pin_item"?n=app.renderSync("base/pin_view_board_pin_item",{board_pin:e}):i&&i.template=="base/board_item"?n=app.renderSync("base/board_item",{board:e,user:app.req.user}):i&&i.template=="explore/explore_item"?n=app.renderSync("explore/explore_item",{explore:e}):i&&i.template=="uc/recommend_item"?n=app.renderSync("uc/recommend_item",{recommend:e}):i&&i.template=="base/explore_board"?n=app.renderSync("base/explore_board",{explore:e,user:app.page.user}):e.channel_board?n=app.renderSync("base/board_item_ent",{type:"normal",req:app.req,board:e}):e.post_id?n=app.renderSync("topics/post_item",{type:"normal",req:app.req,post:e}):e.topic_id||e._new_block?n=app.renderSync("topics/block_item",{type:"normal",req:app.req,pin:e,is_editor:app.page.is_editor,favorite_view:app.page.favorite_view,seq_str:app.page.seq_str,topic_view:app.page.topic_view,fall:app.page.topic_view=="waterfall"}):e.pin_id?n=app.renderSync("base/pin_item",{user:e.user||t.user,pin:e,board:e.board||t.board,hide_user:t&&t.hide_user,show_tag:!0}):e.board_id?n=app.renderSync("base/board_item",{board:e,user:app.req.user}):e.link&&e.image&&!isNaN(e.type)&&!isNaN(e.position)?n=app.renderSync("base/pin_ad",{ad:[e]}):e.google?n=app.renderSync("base/google",e):n=app.renderSync("base/user_item",{user:e,current_user:app.req.user}),(new Element("div")).set("html",n).getFirst()}function f(e){var t;return e.pin_id?t=e.seq?e.seq:e.pin_id:e.board_id?t=e.seq:t=e.user_id,t}var s=!1,o=!1,u=[];i=i||{},t=t||10,typeof n=="function"&&(i=r||{},r=n,n=null);var l=0,c={};return function(h,p){p=p?p:"load";switch(p){case"load":if(s)return;s=!0;var d=h.getLast(),v=d?d.seq:null;h.showIndicator(),typeof n=="number"&&n++,n?(c.page=n,c.per_page=t):(c.max=v,c.limit=t),i.max_loads&&n&&(c.page_loads=c.page,delete c.page),c.wfl=1,i&&i.snapshot&&(c.snapshot=app.page.snapshot),i.time&&(c.time=i.time),i.maxs&&l==0&&(c.maxs=i.maxs);function m(){l++;if(_czc){_czc.push(["_trackPageview",app.joinUrl(e,c)]);if(/^\/search/.test(e)){var o=app.page.query||{};o.type&&o.text&&_czc.push(["_trackEvent","site-search",o.type,o.text,1])}}(new Request.JSON({url:e,noCache:!0,data:c,onSuccess:function(e){h.hideIndicator();if(e.err){app.error(e.msg||app.COMMON_ERRMSG);return}e=r?r(e):{data:e.pins},e.data.length&&e.data.each(function(t){h.append(a(t,e.extra))}),e.maxs&&(c.maxs=e.maxs),e.page&&(n=e.page),n?(e.data.length==0&&h.stopLoader(i.max_loads?!1:!0),i.max_loads&&l>=i.max_loads&&h.stopLoader(!1)):e.data.length<t&&h.stopLoader(i.max_loads?!1:!0),h.fireEvent("loadComplate")},onComplete:function(){s=!1}})).get()}m();break;case"fetch":if(n)return;if(o)return;o=!0;if(u.length>=100)return;var g;u.length>0?g=f(u.getLast()):g=h.getFirstSeq();if(!g)return;(new Request.JSON({url:e+"?fetch",data:{since:g,limit:100,wfl:1},noCache:!0,onSuccess:function(e){if(e.err){app.error(e.msg||app.COMMON_ERRMSG);return}var e=r?r(e):{data:e.pins};if(e.data&&e.data.length>0){u=u.concat(e.data);var t=u.length,n=t>=100?"100+":t;document.title.match(/^\(\d+\)/)?document.title=document.title.replace(/^\(\d+\)/,"("+n+")"):document.title="("+n+") "+document.title,h.showNewIndicator(n+"条新采集")}},onComplete:function(){o=!1,h.scheduleFetcher()}})).get();break;case"show_new":document.title=document.title.replace(/^\(\d+\+?\) /,""),h.hideNewIndicator();var y=[];if(u.length){for(var b=u.length-1;b>=0;b--)y.push(a(u[b]));u=[],h.insert(y)}break;default:app.error("CellLoader unkown action")}}};var Waterfall=new Class({Binds:["resize","scroll","_append","fetchNew"],Implements:[Options,Events],options:{container:null,cellWidth:236,cellSpace:16,minCols:4,maxCols:6,cellSelector:".wfc",sideSpace:0,preservedCols:0,hibernate:5e3,viewportExtend:500,containerSelector:"div.wrapper",loadOffset:100,paddingBottom:!1,loader:null,fetcher:!1,autoResize:!0,scrollEl:window,transitionClass:"wft",containerSelectorOffset:50,scrollTimes:null,maxScrollTimes:null,endEl:null},initialize:function(e,t){this.element=document.id(e),this.setOptions(t),this.container=this.options.container?document.id(this.options.container):app.view,this.cols=0,this.width=0,this.height=0,this.cells=[],this._visibleCells=[],this._isFirstRun=!0,this._isScrolling=!1,this._top=this.element.getCoordinates(this.container).top,this.options.loader&&(this._indicator=this._createIndicator()),this.options.fetcher&&(this._newIndicator=this._createNewIndicator()),this._pending=[],this.options.cellSelector&&this.element.getElements(this.options.cellSelector).forEach(function(e){this.cells.push(this.newCell(e))},this),Cookie.read("wft")&&(Cookie.dispose("wft"),this.options.transitionClass&&this.cells.invoke("addClass",this.options.transitionClass)),this.reposition(!0),this.attach()},toElement:function(){return this.element},newCell:function(e,t){try{e.getElement(".img img").addEvent("load",function(){try{this.getParent(".img").addClass("loaded")}catch(e){}})}catch(n){}var r=new Waterfall.Cell(this,e);return e.hasClass("right")&&(r.fixed="topright"),t&&(r=this._position(r)),r},destroy:function(){this.detach(),this._indicator&&this._indicator.destroy(),this._newIndicator&&this._newIndicator.main.destroy()},_createIndicator:function(){return(new Element("div",{"class":"loading"})).inject(this.element,"after").hide().set("html",'<img src="/img/loading.gif"><span>正在加载...</span>')},_createNewIndicator:function(){var e=new SmoothNotification({duration:!1,container:"#header",id:"NewIndicator"}),t=this;return e.main.addEvent("click",function(){t.options.loader(t,"show_new")}),e},showIndicator:function(){this._indicator&&this._indicator.show()},showNewIndicator:function(e){this._newIndicator&&this._newIndicator.show(e);var t=this._newIndicator.main;t.setStyle("margin-left",-t.getSize().x/2)},hideIndicator:function(){this._indicator&&this._indicator.hide()},hideNewIndicator:function(){this._newIndicator&&this._newIndicator.hide()},fetchNew:function(){this.options.loader(this,"fetch")},scheduleFetcher:function(){this._newIndicator&&(this._fetchTimer&&clearTimeout(this._fetchTimer),this._fetchTimer=setTimeout(this.fetchNew,3e4))},attach:function(){this.options.autoResize&&window.addEvent("resize",this.resize),this.options.scrollEl&&this.options.scrollEl.addEvent("scroll",this.scroll),this.scheduleFetcher()},detach:function(){this.options.autoResize&&window.removeEvent("resize",this.resize),this.options.scrollEl&&this.options.scrollEl.removeEvent("scroll",this.scroll),this._fetchTimer&&(clearTimeout(this._fetchTimer),delete this._fetchTimer)},resize:function(){return this.reposition()},scroll:function(){this._updateViewport();if(!this.options.loader||this._stopLoading||this._pending.length)return;var e=this.options.scrollEl.getSize().y,t=this.options.scrollEl.getScroll().y,n=this._hs[this._minCol||0]+this._top;if(t+e<n-this.options.loadOffset)return;if(this._isScrolling)return;var r=this;this._isScrolling=!0,setTimeout(function(){r.beginRequireLogin()&&r.options.loader(r),r._isScrolling=!1},200)},stopLoader:function(e){return this._stopLoading=!0,e&&this._indicator&&this._indicator.set("html",this.options.endEl||'<img src="/img/end.png">').show(),this.options.paddingBottom&&this._equalise(),this},startLoader:function(){return this._stopLoading=!1,this._indicator&&(this._indicator.destroy(),this._indicator=this._createIndicator()),this},beginRequireLogin:function(){return app.req.user||!this.options.scrollTimes&&0!==this.options.scrollTimes?!0:(0>=--this.options.scrollTimes&&this._isFirstRun&&(app.requireLogin("",{to:"login"}),this._isFirstRun=!1),1>--this.options.maxScrollTimes?(0===this.options.maxScrollTimes&&app.requireLogin("",{to:"login"}),!1):!0)},getColsHeight:function(){return this._hs},getLast:function(){return this.cells.getLast()},getFirst:function(e){var t=this.cells;for(var n=0;n<t.length;n++)if(t[n].seq)return e?{cell:t[n],index:n}:t[n];return null},getFirstSeq:function(e){var t=this.getFirst();return t?t.seq:-1},reposition:function(e){if(this._layout(e)){var t=this.cells;for(var n=0,r=t.length;n<r;n++)this._position(t[n]);this._updateViewport(!0),this.options.paddingBottom&&this._equalise(),this.fireEvent("layout",this)}return this},update:function(e){e=typeOf(e)==="element"?e.retrieve("wf:cell"):e;var t=e.col,n=e.getElementHeight(),r=n-e.height,i=this.cells,s=i.indexOf(e),o=[];for(var u=s+1,a=i.length;u<a;u++){var f=i[u];f.col===t&&f.position(f.left,f.top+r,t)}return e.updateHeight(),this._hs[t]+=r,this.options.paddingBottom&&this._equalise(),f=this.porscheSubCell,f&&f.col==e.col&&e.top<f.top&&(f.position(f.left,f.top+r,t),this._adjustPorscheCell()),this},remove:function(e){e=$$(e),e.each(function(e){var t=e.dispose().retrieve("wf:cell");t.attached&&this._visibleCells.erase(t),this.cells.erase(t)}.bind(this)),this.reposition(!0)},insert:function(e){e=$$(e);var t=this.getFirst(!0);!t&&this.cells.length===1&&(t={index:1});var n=t?t.index:0,r=e.map(function(e){return this.newCell(e)},this);r.unshift(n,0),Array.prototype.splice.apply(this.cells,r),docScroller.toTop(),this.reposition(!0)},append:function(e){var t=this.newCell(e,!0);return this.cells.push(t),this},_position:function(e){var t=this.cols-this.options.preservedCols,n=0,r=this._hs;if(e.fixed==="topright")n=t-1;else for(var i=0;i<t;i++)r[i]<r[n]&&(n=i);var s=n*(this.options.cellWidth+this.options.cellSpace),o=r[n];e.position(s,o,n),r[n]+=e.height+this.options.cellSpace;var u=min=0;for(var i=0;i<t;i++)r[i]<r[min]&&(min=i),r[i]>r[u]&&(u=i);return this._maxCol=u,this._minCol=min,this._height=r[u]+this.options.containerSelectorOffset,this.element.setStyle("height",this._height),e},_equalise:function(){var e=this.cols-this.options.preservedCols;this._snaps=this._snaps||new Elements;if(this._snaps.length<e){var t=e-this._snaps.length;t.times(function(){this._snaps.push((new Element("div")).addClass("padding-block"))},this)}this._snaps.dispose();var n=this._hs,r=n[this._maxCol],i=0;for(var s=0;s<e;s++)i=r-n[s]-this.options.cellSpace,this._snaps[s].setStyles({height:r===n[s]||i<0?0:i,left:s*(this.options.cellWidth+this.options.cellSpace),top:n[s],width:this.options.cellWidth,paddingBottom:r===n[s]?40:60}).inject(this.element)},getVisibleCells:function(){var e=this._visibleCells,t=e.length,n=new Array(t);while(t--)n[t]=e[t];return n},_updateViewport:function(e){if(!this.options.hibernate||this._height<this.options.hibernate)return;var t=this.cells.length;if(t==0)return;var n=window.getScroll().y;this._lastScroll=this._lastScroll||0;var r=Math.abs(n-this._lastScroll);if(!e&&r<50)return;var i=window.getSize().y,s=this.element.getTop(),o=n>s?n-s:0,u=o+i+this.options.viewportExtend;o-=this.options.viewportExtend,o<0&&(o=0),this._viewport=[o,u],this._updateCells(),this._lastScroll=n},cellVisible:function(e){var t=this._viewport[0],n=this._viewport[1];return!(e.bottom<t||e.top>n)},_updateCells:function(){var e=this._viewport[0],t=this._viewport[1],n=this.cells,r=n.length,i=r-1,s=0,o=0,u=[];while(i>s){o=Math.floor((s+i)/2);var a=n[o];if(a.bottom<e||a.top>t){if(a.top>t){i=o-1;continue}s=o+1;continue}break}u.push(n[o]);for(var f=o+1,l=10;f<r&&l>0;f++){var a=n[f];a.bottom<e||a.top>t?l--:u.push(a)}for(var f=o-1,l=10;f>=0&&l>0;f--){var a=n[f];a.bottom<e||a.top>t?l--:u.unshift(a)}var c=this.getVisibleCells().filter(function(n){return!u.contains(n)&&(n.bottom<e||n.top>t)});u.invoke("attach"),c.invoke("detach")},_layout:function(e){var t=this.options.cellWidth+this.options.cellSpace,n=Math.floor((this.container.getWidth()-this.options.sideSpace*2)/t);n>this.options.maxCols&&(n=this.options.maxCols),n<this.options.minCols&&(n=this.options.minCols);if(!e&&this.cols===n)return!1;var r=[];for(var i=0;i<n;i++)r.push(0);return this.width=n*t-this.options.cellSpace,this.cols=n,this._hs=r,$$(this.options.containerSelector).setStyle("width",this.width),!0}});Waterfall.Cell=new Class({initialize:function(e,t){this.waterfall=e,this.element=document.id(t),this.element.store("wf:cell",this).setStyle("position","absolute").inject(this.waterfall.toElement()),this.fixed=t.hasClass("topright")?"topright":t.hasClass("topleft")?"topleft":!1,this.updateHeight(),this.seq=t.get("data-seq"),this.col=0,this.left=this.top=this.bottom=-1,this.html=null,this.attached=!!this.element.parentNode,this._register()},toElement:function(){return this.element},updateHeight:function(){this.element.parentNode?this.height=this.element.getHeight():(this.element.setStyle("top",-1e3).inject(this.waterfall.toElement()),this.height=this.element.getHeight(),this.element.setStyle("top",this.top).dispose())},getElementHeight:function(){return this.element.getHeight()},position:function(e,t,n){this.left=e,this.top=t,this.bottom=this.top+this.height,this.col=n,this.element.setStyles({left:this.left,top:this.top})},_register:function(){var e=this.toElement();this.height=e.clientHeight>0?e.clientHeight:this.height,this.attached?this.waterfall._visibleCells.include(this):this.waterfall._visibleCells.erase(this)},attach:function(e){if(this.attached)return;var t=this.toElement();this.html&&t.set("html",this.html),this.html=null,t.inject(this.waterfall.toElement(),e||"bottom"),Modernizr.csstransitions?t.setStyle("opacity",1):t.setStyle("display",""),this.attached=!0,this._register()},detach:function(){if(!this.attached)return;var e=this.toElement();this.html=e.get("html"),e.dispose().set("html",""),Modernizr.csstransitions?e.setStyle("opacity",0):e.setStyle("display","none"),this.attached=!1,this._register()}}),["getSize"].forEach(function(e){Waterfall.Cell.implement(e,function(){return Element.prototype[e].apply(this.element,arguments)})}),["addClass","setStyles","setStyle"].forEach(function(e){Waterfall.Cell.implement(e,function(){return Element.prototype[e].apply(this.element,arguments),this})});var Uploadr=new Class({Implements:[Options,Events,Class.Occlude],options:{url:"/upload/",uploadText:"正在上传...",fieldName:"file"},property:"Uploadr",initialize:function(e,t){this.target=this.element=document.id(e);if(this.occlude())return this.occluded;this.setOptions(t),this.box=(new Element("div")).setStyles({position:"absolute",opacity:.01,overflow:"hidden"}).inject(this.target,"after"),this.btn=new Button(this.target,{disabledTitle:this.options.uploadText,click:function(){return this.file.click(),!1}.bind(this)}),this.create()},create:function(){this.clear(),this.iframe||(this.iframe=(new IFrame({src:"javascript:'<html></html>'",frameborder:"no",border:0})).inject(this.box),this.iframe.addEvents({load:this.onLoad.bind(this)})),Browser.ie?(this.iframe.setStyles({width:300,height:30}),this.runner=this.createIBody.periodical(50,this)):(this.iframe.setStyle("display","none"),this.createInput())},createIBody:function(){var e=this.iframe.contentWindow.document;if(!e||!e.body)return;clearTimeout(this.runner),e.body.innerHTML='<form method="post" enctype="multipart/form-data" id="form"><input type="file" id="file" style="position:absolute;left:0;top:0;" /><div id="data"></div></form><style type="text/css">body{background:#FCF9F9;}input{border: 1px solid #999;padding: 5px;}</style>',this.doc=e,this.processIBody.delay(50,this)},processIBody:function(){if(!(this.file=this.doc.getElementById("file"))||!this.file.offsetHeight)return this.createIBody();this.file.onchange=this.select.bind(this)},createInput:function(){var e=this.file=(new Element("input",{type:"file",name:this.options.fieldName,size:1,styles:{position:"absolute",top:0,left:0,border:0}})).inject(this.box);e.onfocus=function(){return!1},e.onchange=this.select.bind(this)},onLoad:function(){if(!this.iframe.parentNode)return;var e=this.iframe.contentWindow.document,t=e.body.innerHTML;if(this.loaded===!1)this.loaded=!0;else if(t!==""){this.loaded=!0;var n=t.match(/(\{.+\})/g);t=JSON.decode(n[0],!0),t.err?this.fireEvent("failed",[t]):this.fireEvent("complete",[t]),this.enable(),this.create()}},disable:function(){this.btn&&this.btn.disable(),this.disabled=!0},enable:function(){this.btn&&this.btn.enable(),this.disabled=!1},select:function(){this.disabled||this.disable(),this.file.onchange=this.file.onmousedown=this.file.onfocus=null,this.options&&this.options.copyrightClass&&(this.is_creation=this.element.hasClass(this.options&&this.options.copyrightClass));if(Browser.ie){var e=this.iframe.contentWindow.document;this.form=e.forms[0],this.file=this.form.elements[0]}else this.form=(new Element("form",{method:"post",enctype:"multipart/form-data",target:this.iframe.get("name"),styles:{width:0,height:0,overflow:"hidden"}})).adopt(this.file).inject(this.box);this.form.action=this.is_creation?this.options.copyrightUrl:this.options.url,this.file.name=this.options.fieldName,this.fireEvent("start"),this.form.submit(),Browser.ie&&this.iframe.set("visibility","hidden")},reposition:function(){var e=this.target.getCoordinates(this.box.getOffsetParent());this.box.setStyles(e)},clear:function(){Browser.ie||this.form&&this.form.destroy(),this.form=null,this.is_creation=null,this.file=null}}),FixedHeader=new Class({Implements:[Options,Events],options:{scrollOffset:0,transition:!1,scrollElement:window},initialize:function(e,t){this.setOptions(t),this.element=document.id(e),this.options.transition&&this.element.addClass(this.options.transition),window.setTimeout(function(){this.scrollOffset=this.scrollOffset||this.element.getCoordinates().top}.bind(this),100),this.scrollOffset=this.options.scrollOffset,this.scrollElement=document.id(this.options.scrollElement),this.isPinned=!0,this.boundScroll=this._scroll.bind(this),this._init()},_init:function(){this._scroll()},_pin:function(){this.element.isDisplayed()||this.element.show(),this.fireEvent("pin")},_unpin:function(){this.fireEvent("unpin")},_tick:function(e){this.element.setStyle("left",-e.x+"px"),this.fireEvent("tick",[e])},_scroll:function(){var e=this.scrollElement.getScroll();!this.isPinned&&e.y>this.scrollOffset?(this._pin(),this.isPinned=!0):this.isPinned&&e.y<this.scrollOffset&&(this._unpin(),this.isPinned=!1),this._tick(e)},attach:function(){return this.scrollElement.addEvent("scroll",this.boundScroll),this},detach:function(){return this.scrollElement.removeEvent("scroll",this.boundScroll),this}}),SmoothNotification=new Class({Implements:[Options],options:{duration:3e3,styles:{position:"absolute","z-index":999999,"text-align":"center"},dispose:!0,style:"normal",relative:{to:"",position:"topcenter",edge:"bottomcenter",offset:{x:0,y:0}},fadeType:"down",horizontalCenter:!1,verticalCenter:!1,closeButton:!1,arrow:!1,arrowColor:"rgba(0, 0, 0, 0.6)",arrowStyles:{},mask:!1,maskStyle:{},id:"",container:"",hideNotiOnclickMask:!0},initialize:function(e){this.setOptions(e),this.main=new Element("div.smooth-notification"),this.mask=new Element("div.sm-mask"),this.closeButton=(new Element("div.sm-closeButton")).addEvent("click",function(){this.hide()}.bind(this)),this.isShowing=!1,this.options.container&&(this.options.parent=document.getElement(this.options.container)),this.options.id&&(this.main.id=this.options.id)},setPosition:function(){this.main.inject(this.options.parent||document.body),this.options.relative.to?this.main.position({relativeTo:this.options.relative.to,position:this.options.relative.position,edge:this.options.relative.edge,offset:this.options.relative.offset}):(this.options.horizontalCenter&&this.main.setStyle("left",document.documentElement.clientWidth/2+window.getScroll().x-this.main.getSize().x/2),this.options.verticalCenter&&(this.main.getStyle("position")!="fixed"?this.main.setStyle("top",document.documentElement.clientHeight/2+window.getScroll().y-this.main.getSize().y/2):this.main.setStyle("top",document.body.getSize().y/2-this.main.getSize().y/2)))},setCloseButton:function(){this.options.closeButton?this.closeButton.inject(this.main):this.closeButton.dispose},setArrow:function(){var e=this.main.getElement(".sm-arrow");e&&e.destroy();if(!this.options.arrow)return;var t=!0;this.options.arrowColor!="rgba(0, 0, 0, 0.6)"&&(t=!1),Browser.ie6&&this.main.setStyle("filter",0);var n=new Element("div.sm-arrow");t?n.set("class","sm-arrow pic-"+this.options.arrow):(n.set("class","sm-arrow border-arrow border-"+this.options.arrow),this.options.arrow=="down"&&n.setStyle("border-top-color",this.options.arrowColor),this.options.arrow=="up"&&n.setStyle("border-bottom-color",this.options.arrowColor),this.options.arrow=="left"&&n.setStyle("border-right-color",this.options.arrowColor),this.options.arrow=="right"&&n.setStyle("border-left-color",this.options.arrowColor)),n.setStyles(this.options.arrowStyles).inject(this.main)},setMask:function(){if(!this.options.mask)return;var e=document.html.getScrollSize();(Browser.ie6||Browser.ie7)&&this.mask.setStyles({width:document.body.offsetWidth,height:document.body.offsetHeight,position:"absolute"}),this.mask.setStyles(this.options.maskStyle).inject(document.body),this.options.hideNotiOnclickMask&&this.mask.addEvent("click",function(){this.hide()}.bind(this))},setDefaultOption:function(e){e=="window"&&(this.options.horizontalCenter=this.options.verticalCenter=!0)},show:function(e,t){return this.setOptions(t),this.main.dispose(),clearTimeout(this.hideTimer),clearTimeout(this.disposeTimer),e&&(this.main.empty(),typeOf(e)=="string"?this.main.grab(new Element("a.notification",{html:e})):this.main.adopt(e)),this.setDefaultOption(this.options.style),this.setCloseButton(),this.main.set("class",["smooth-notification",this.options.fadeType,this.options.style].join(" ")),this.main.setStyles(this.options.styles),this.setPosition(),this.setArrow(),this.setMask(),this.main.setStyles(this.options.styles),function(){this.main.addClass("show")}.delay(150,this),this.options.duration&&(this.hideTimer=function(){this.hide()}.delay(this.options.duration+150,this)),this.isShowing=!0,this},hide:function(){return this.main.removeClass("show"),this.mask.dispose(),this.disposeTimer=function(){this.options.dispose&&this.main.dispose(),this.options.complete&&this.options.complete()}.delay(150,this),this.isShowing=!1,this}}),Gestures=new Class({Extends:Drag,options:{snap:10,minX:150,maxY:100,style:!1,modifiers:{},preventDefault:!0,stopPropagation:!0},initialize:function(e){this.parent(document.body,e),this.bound.eventStop=Function.from(!0),this.bound.contextMenu=this._contextmenu.bind(this),this.addEvents({drag:this._drag.bind(this),complete:this._complete.bind(this)}),this._skipmenu=0,this.document.addEvent("contextmenu",this.bound.contextMenu),Modernizr.canvas&&(this.canvas=new Element("canvas",{styles:{position:"fixed",top:0,left:0,zIndex:10001}}))},start:function(e){return!e.rightClick||Browser.Platform.linux?!0:Browser.Platform.mac&&!e.control&&!e.meta?!0:(this.canvas&&this.canvas.setProperties({width:window.innerWidth,height:window.innerHeight}),e.rightClick=!1,this._skipmenu=1,this.parent(e))},cancel:function(e){return this.canvas&&this.canvas.dispose(),e&&(this._skipmenu=0),this.parent(e)},stop:function(e){return e&&e.rightClick&&e.preventDefault(),this.parent(e)},_contextmenu:function(e){return!this._skipmenu},_complete:function(e,t){this.canvas&&this.canvas.dispose();var n=this.mouse.now.x-this.mouse.start.x,r=this.mouse.now.y-this.mouse.start.y;if(Math.abs(n)<this.options.minX||Math.abs(r)>this.options.maxY)return;n>0?this.fireEvent("forward"):this.fireEvent("back")},_drag:function(e,t){if(!this.canvas)return;var n=window.getScroll(),r=this.canvas.getContext("2d");r.strokeStyle="rgba(233,59,72,0.83)",r.lineWidth=5,r.lineCap="round",r.lineJoin="round",r.shadowColor="rgba(0,0,0,0.45)",r.shadowOffsetX=2,r.shadowOffsetY=2,r.shadowBlur=3,r.clearRect(0,0,this.canvas.width,this.canvas.height),r.beginPath(),r.moveTo(this.mouse.start.x-n.x,this.mouse.start.y-n.y),r.lineTo(this.mouse.now.x-n.x,this.mouse.now.y-n.y),r.stroke(),this.canvas.parentNode||document.body.appendChild(this.canvas)}}),SlidePage=new Class({Extends:Fx,options:{direction:"right",fixedSelector:null},initialize:function(e,t){this.element=document.id(e),this.container=document.id(document.body),this.view=app.view,this.elevatorItem=document.id("elevator_item"),this.parent(t),this.left=this.options.direction==="left"},prepareShow:function(){var e=Object.append(this.container.getSize(),{scroll:this.container.getScroll()});return e.from=0,this.left?e.to=-e.x:e.to=e.x,this.container.setStyles({overflow:"hidden"},!0),this.view.setStyles({position:"absolute",top:0,width:this.view.getSize().x},!0),this.element.setStyles({position:"absolute",top:e.scroll.y,left:this.left?0-e.x:e.x,width:e.x,height:e.y},!0),this.elevatorItem&&this.elevatorItem.hide(),this.options.fixedSelector&&document.getElements(this.options.fixedSelector).absolutize(),app.page.$header&&app.page.$header.detach(),e},prepareHide:function(){var e=this.state;return this.view.setStyles({top:0}),this.element.setStyles({top:e.scroll.y,width:e.x,height:e.y}),this.container.setStyles({overflow:"hidden"}).scrollTo(e.scroll.x,e.scroll.y),this.elevatorItem&&this.elevatorItem.hide(),this},set:function(e){return this.view.setStyle("left",-e),this.element.setStyle("left",this.left?-(this.state.x+e):this.state.x-e),this},show:function(){var e=this.state=this.prepareShow();return this.start(e.from,e.to).chain(function(){this.element.setStyles({top:0}),this.container.scrollTo(0,0),this.callChain()}.bind(this))},hide:function(){var e=this.state;return this.prepareHide().start(e.to,e.from).chain(function(){this.elevatorItem&&this.elevatorItem.show(),this.element.restoreStyles(),this.view.restoreStyles().setStyles({width:"auto"}),this.container.restoreStyles().scrollTo(e.scroll.x,e.scroll.y),this.options.fixedSelector&&document.getElements(this.options.fixedSelector).unabsolutize(),app.page.$header&&app.page.$header.attach(),delete this.state,this.callChain()}.bind(this))}}),MessageChecker=new Class({Implements:[Options,Events],options:{interval:3e4,indicator:".menu-bar .alert-nav .num"},initialize:function(e){this.setOptions(e),this.indicator=document.getElement(this.options.indicator),this.attach()},fetchNow:function(){if(this.fetching)return;this.fetching=!0,(new Request.JSON({url:"/message/unread/",noCache:!0,onSuccess:function(e){this.unreadActivities=e.unread_feeds,this.unreadMentions=e.unread_mentions,this.updateIndicator(e.unread_feeds+e.unread_mentions)}.bind(this),onComplete:function(){this.fetching=!1}.bind(this)})).get()},scheduleFetcher:function(e){this._fetchTimer&&clearTimeout(this._fetchTimer),e&&this.fetchNow()},updateIndicator:function(e){this.indicator.innerHTML=e,e==0?this.indicator.addClass("hidden"):this.indicator.removeClass("hidden")},attach:function(){this.scheduleFetcher(!0)},detach:function(){this._fetchTimer&&(clearTimeout(this._fetchTimer),delete this._fetchTimer)}}),TabSwitcher=new Class({Implements:[Class.Occlude,Events,Options],property:"TabSwitcher",initialize:function(e){this.el=document.id(e);var t=this.el.get("data-select");return this.init(),this.selectTab(Number(t)),this},init:function(){return this.tabEls=this.el.getElements(".tab"),this.contentEls=this.el.getNext().getElements(".content"),this.bindingEvents(),this},bindingEvents:function(){var e=this;this.tabEls.addEvent("click",function(t){var n=e.tabEls.indexOf(this);e.selectTab(n),t.preventDefault(),t.stopPropagation()})},selectTab:function(e){return this.selectIndex()===e?this:(this.tabEls.removeClass("active"),this.tabEls[e].addClass("active"),this.contentEls.hide(),this.contentEls[e].show(),this)},selectIndex:function(){var e=0;return this.tabEls.each(function(t,n){t.hasClass("active")&&(e=n)}),e},size:function(){return this.tabEls.length}}),TagInput=new Class({Implements:[Class.Occlude,Events,Options],initialize:function(e){return this.el=e,this.init(),this.build(),this.attachEvents(),this},init:function(){return this.el.value?this.tags=this.el.value.split(","):this.tags=[],this},build:function(){this.el.hide(),this.inputEl=new Element("input",{"class":this.el.get("class")}),this.labelInputEl=new Element("div",{"class":"tag-labels"}),this.contentEl=new Element("div",{"class":"tag-input"}),this.placeholderEl=new Element("div",{"class":"placeholder",text:this.el.get("placeholder")});var e=this;return this.tags.each(function(t){e.insertTagValue(t)}),this.tags.length&&this.placeholderEl.hide(),this.labelInputEl.inject(this.contentEl),this.inputEl.inject(this.contentEl),this.placeholderEl.inject(this.contentEl),this.contentEl.inject(this.el.getParent()),this},updateInput:function(){return this.tags.length?(this.el.value=this.tags.join(","),this.placeholderEl.hide()):this.el.value="",this},attachEvents:function(){var e=this;this.inputEl.addEvents({keydown:function(t){if(~["enter","space"].indexOf(t.key)){var n=e.inputEl.value;e.addTag(n),t.preventDefault()}else if(~["backspace"].indexOf(t.key)&&!e.inputEl.value.trim().length){var r=e.tags.length,i=e.tags[r-1];if(!i)return;e.removeTag(i)}},focus:function(){e.placeholderEl.hide()},blur:function(){var t=e.inputEl.value;e.addTag(t),e.tags.length||e.placeholderEl.show()}}),this.labelInputEl.addEvent("click:relay(.tag-label)",function(){var t=this;e.removeTag(t.get("data-tag"))}),this.contentEl.addEvent("click",function(){e.inputEl.focus()})},insertTagValue:function(e){var t=new Element("label",{"class":"tag-label"}),n=e+'<i class="icon close"></i>';return t.set("html",n),t.set("data-tag",e),t.inject(this.labelInputEl),this},addTag:function(e){return!e||!e.length?this.tags:(e=e.trim(),this.tags.some(function(t){return t===e})||(this.tags.push(e),this.insertTagValue(e)),this.inputEl.set("value",""),this.updateInput(),this.tags)},removeTag:function(e){this.tags=this.tags.filter(function(t){return t!==e});var t=this.labelInputEl.getChildren(".tag-label");return t.each(function(t){t.get("data-tag")===e&&t.destroy()}),this.updateInput(),this.tags},getTags:function(){return this.tags},getValue:function(){return this.getTags()},clear:function(){this.tags=[];var e=this.labelInputEl.getChildren();return e.each(function(e){e.destroy()}),this},retrieveInput:function(){return this.inputEl}});app.pinOrganizer=function(e){function m(){n.options.hibernate=!1,w(function(){n.cells.each(function(e){e.updateHeight()}),n.reposition(!0)}),i.addClass("editing"),r.getElements(".huaban-share-unit, .edit, .organize").hide(),(new Elements([a,u,s,o])).show(),document.body.addEvents(S),y(),app.page.isOrganizing=s}function g(){if(Browser.ie6){location.reload();return}E(),i.removeClass("editing"),r.getElements(".huaban-share-unit, .edit, .organize").show(),(new Elements([a,u,s,o])).hide(),$$(".pin.selected").removeClass("selected"),$$(".pin .pin-overlay").destroy(),document.body.removeEvents(S),_.hide(),n.cells.each(function(e){e.updateHeight()}),n.reposition(!0),b(),app.page.isOrganizing=!1}function y(){l.inject(app.view)}function b(){l.dispose()}function w(e){Asset.css("/css/organizing_pins.css",{id:"organizing_style",events:{load:e}})}function E(){document.id("organizing_style").destroy()}function x(e){f.clone().cloneEvents(f).inject(e.getElement("a.img"))}function T(){this.getElement(".pin-overlay")||x(this),this.getElement(".pin-overlay").show()}function N(){this.hasClass("selected")||this.getElement(".pin-overlay").hide()}function C(e){e.each(function(e){e.getElement(".pin-overlay")||x(e),e.addClass("selected").getElement(".pin-overlay").show()})}function k(e){e.each(function(e){e.removeClass("selected").getElement(".pin-overlay").hide()})}function L(e){var t=$$(".pin.selected");t.addClass("edited"),e.forEach(function(e){t.each(function(t){var n=t.getElements(".tag-cover .tag"),r=n.filter(function(t){var n=t.get("data-tag");return n===e});if(!r.length){var i=new Element("label",{text:e,"class":"tag"});i.set("data-tag",e),i.inject(t.getElement(".tag-cover"))}})})}function A(e){var t=$$(".pin.selected");if(!t.length)return app.alert("请选择采集");t.addClass("edited"),t.each(function(t){var n=t.getElements(".cover .tag");n.each(function(t){var n=t.get("data-tag");n===e&&t.destroy()})})}function O(){var e=$$(".pin.edited"),t=e.map(function(e){var t=e.getElements(".cover .tag"),n=t.map(function(e){return e.get("data-tag")}),r=e.get("data-id");return{pinId:r,tags:n}});if(!t.length)return;(new Request.JSON({url:"/pin/tags/",data:{pinTags:t},onSuccess:function(e){if(e.hasOwnProperty("err"))return app.alert(e.msg);app.msg("更新tags成功")},onError:function(e){app.error(e)}})).post()}function M(e){if(e.key=="a"&&(Browser.Platform.mac&&e.meta||!Browser.Platform.mac&&e.control))return v.removeClass("uncheck").click(),!1;if(e.key==="esc"&&!e.control&&!e.meta&&!e.shift)return v.addClass("uncheck").click(),!1}function D(e){if(!e.length)return;e.each(function(e){var t=n.element.getChildren("[data-id="+e+"]");n.remove(t)}),n.reposition(!0);var t=document.getElement("#board_card .tabs .pins");t.innerHTML=t.innerHTML.toInt()-e.length+"采集"}function H(e){setTimeout(function(){Object.keys(P.getRunning()).length&&app.msg("删除进行中，请稍候...",{type:"notice",timeout:!1,modal:!0})},500);var t=[],n=[];P.clear(),e.each(function(e,r){P.addRequest("d"+r,new Request.JSON({url:"/pins/"+e+"/",method:"post",data:{_method:"DELETE"},onComplete:function(r){!r||r&&r.err?t.push(e):n.push(e);if(!P.hasNext()){var i=function(){var e="成功删除 "+n.length+" 个采集";t.length&&(e+="，失败 "+t.length+" 个采集"),app.msg(e,{timeout:4e3}),D(n)};$$(".floating-notice").destroy(),i()}}})).send("d"+r)})}function B(e,t){setTimeout(function(){Object.keys(P.getRunning()).length&&app.msg("正在移动采集，请稍候...",{type:"notice",timeout:!1,modal:!0})},500);var n=[],r=[];P.clear(),e.each(function(e,i){P.addRequest("d"+i,new Request.JSON({url:"/pins/"+e+"/",method:"post",data:{board_id:t,moveonly:1},onComplete:function(i){!i||i&&i.err?n.push(e):r.push(e);if(!P.hasNext()){var s=function(){var e="成功移动"+r.length+"个采集";n.length&&(e+="，失败"+n.length+"个采集"),r.length&&(e+='，<a href="/boards/'+t+'/">查看采集</a>'),app.msg(e,{timeout:4e3}),D(r)};$$(".floating-notice").destroy(),s()}}})).send("d"+i)})}var t,n,r=e.getParent(".action-buttons"),i=r.getParent(".inner"),s=(new Element("a.btn.wbtn.btn13.over",{html:"<strong>完成</strong>",events:{click:function(){O(),g()}}})).inject(r).hide(),o=(new Element("a.btn.wbtn.btn13.tag",{html:"<strong>添加标签</strong>",events:{click:function(){var e=$$(".pin.selected");if(!e.length)return app.alert("请先选择采集再打标签");_czc.push(["_trackEvent","batch-tagging","pincount",e.length]),app.requireImportOldTags(function(){var e=app.showDialogBox("tag_dialog");e.addEvent("confirm",function(e){var t=e.tags;L(t),v.addClass("uncheck").click()})})}}})).inject(r).hide(),u=(new Element("a.btn.rbtn.btn13.delete",{html:"<strong>删除</strong>"})).inject(r).hide(),a=(new Element("a.btn.wbtn.btn13.move",{html:"<strong>移动至...</strong>"})).inject(r).hide(),f=new Element(".pin-overlay",{events:{click:function(){return this.getParent(".pin").toggleClass("selected"),!1}},html:'<i class="btn-select"></i>'}),l=new Element(".sub-toolbar"),c=a.clone().addEvent("click",function(){a.click()}).inject(l).set("style",""),h=o.clone().addEvent("click",function(){o.click()}).inject(l).set("style",""),p=u.clone().addEvent("click",function(){u.click()}).inject(l).set("style",""),d=s.clone().addEvent("click",function(){s.click()}).inject(l).set("style",""),v=(new Element("a.btn.btn13.rbtn.check",{html:"<strong>全选</strong>"})).inject(l),S={"mouseenter:relay(.pin)":T,"mouseleave:relay(.pin)":N,keydown:M},_=new SmoothNotification({relative:{to:document.id("board_card"),position:"centertop",edge:"centertop",offset:{y:16}},styles:{"border-radius":"5px"},duration:4e3});e.onclick=function(){return n=app.page.$waterfall,t=n.options.cellWidth,m(),_.show("提示：选中采集后，点击右侧按钮可以批量移动或删除"),!1};var P=new Request.Queue({stopOnFailure:!1});u.addEvent("click",function(){_&&_.hide();var e=$$(".pin.selected").get("data-id").clean();if(!e.length){app.error("你还没有选择任何采集哦！");return}app.confirm({text:"确定要删除吗？删除采集后不能恢复",action:"删除"},function(t){if(!t)return;H(e)})}),a.addEvent("click",function(){_&&_.hide();var e=$$(".pin.selected").get("data-id").clean();if(!e.length){app.error("你还没有选择任何采集哦！");return}var t=app.showDialogBox("move_pins",{is_creation:app.page.board.extra&&app.page.board.extra.is_creation})[1],n=t.getElement(".board-list");t.getElement(".go").addEvent("click",function(){var t=n.get("data-board-id");if(t===app.page.$url.split("/")[2]){alert("不能移动到当前画板");return}app.hideAllDialogBox(),B(e,t)}),t.getElement(".close-btn").addEvent("click",function(){app.hideDialogBox("move_pins")})}),v.addEvent("click",function(){this.hasClass("uncheck")?(k($$(".pin.selected")),this.removeClass("uncheck").getElement("strong").innerHTML="全选"):(C($$(".pin")),this.addClass("uncheck").getElement("strong").innerHTML="取消全选")})};var HuabanHotkeys=new Class({Implements:[Options,Events],options:{defaultEventType:"keydown"},initialize:function(e){this.setOptions(e),this.setEvents(),this.keyboard=new Keyboard({defaultEventType:this.options.defaultEventType,events:this.options.events}),this.startListening(),this.leadings={},this.scroll=function(e){var t=document.id("pin_view_layer")||document.body;(new Fx.Scroll(t,{duration:150,transition:"linear"})).start(0,t.getScroll().y+t.getSize().y*2/3*(e=="down"?1:-1))}},setEvents:function(){var e=this;this.options.events={t:function(t){if(e.checkEditor())return},"¾":function(){if(e.checkEditor())return;var t=document.id("pin_view_layer");if(t)return(new Fx.Scroll(t)).toTop();var n=document.id("NewIndicator");n&&n.getStyle("display")=="block"?n.fireEvent("click"):window.docScroller.toTop()},"shift+¿":function(){if(e.checkEditor())return;e.win&&e.win.isShowing?e.hideIntro():e.showIntro()},right:function(){if(e.checkEditor())return;var t=document.id("zoomr_hide");if(t)return t.click();var n=document.getElement("#pin_view_layer .pin-view-arrows .next"),r=document.getElement("#pin_view_layer .pin-view");n&&r&&r.get("data-media-type")!=1&&n.click()},left:function(){if(e.checkEditor())return;var t=document.id("zoomr_hide");if(t)return t.click();var n=document.getElement("#pin_view_layer .pin-view-arrows .prev"),r=document.getElement("#pin_view_layer .pin-view");n&&r&&r.get("data-media-type")!=1&&n.click()},"¿":function(){if(e.checkEditor())return;var t=document.id("query");if(t)return setTimeout(function(){t.highlight().select()},100),!1},esc:function(t){var n=document.id("zoomr_hide"),r=document.getElement(".menu-bar .add-nav .menu"),i=document.id("pin_view_layer"),s=document.getElement("#pin_view_layer .zoom-layer");if(e.checkEditor())return t.target.blur(),t.stop();if(app.hideAllDialogBox())return t.stop();if(r&&r.getStyle("display")!=="none")return r.hide(),t.stop();if(e.win&&e.win.isShowing)return e.win.hide(),t.stop();if(app.hideDialog())return t.stop();if(app.hideSheet())return t.stop();if(n)return n.fireEvent("click"),t.stop();if(app.page.dmController&&app.page.dmController.isShowing)return app.page.dmController.hide(),t.stop();if(s&&s.getStyle("display")!=="none")return s.getElement(".close-zoom").click(),t.stop();if(i)return i.getElement(".close-layer").click(),t.stop()},enter:function(){if(e.checkEditor())return;var t=document.getElement("#dialog_alert .buttons .action"),n=document.getElement("#repin_dialog");t?t.click():n&&n.getStyle("display")=="block"&&n.getElement(".buttons .action").click()},n:function(t){if(e.checkEditor())return;if(t.code==78){var n=document.getElement("#elevator_item .plus-popup a");n&&n.click()}else t.code==110&&e.options.events["¾"]()},f:function(){if(e.checkEditor())return;var t=document.id("pin_view_layer"),n=document.getElement(".pin-view .tool-bar .zoomin");if(!n)return;if(t)t.getElement(".zoom-layer").getStyle("display")=="none"?n.click():t.getElement(".zoom-layer .close-zoom").click();else{var r=document.id("zoomr_hide"),i=document.id("zoomr");n&&!i&&n.click(),r&&i.getStyle("left")=="0px"&&r.click()}},o:function(){if(e.checkEditor())return;var t=document.getElement(".pin-view .image-holder>a");t&&t.click()},r:function(){if(e.checkEditor())return;var t=document.getElement(".pin-view .tool-bar .repin-btn");t&&t.click()},d:function(){if(e.checkEditor())return;var t=document.getElement(".pin-view .tool-bar .del-btn");t&&t.click()},g:function(){if(e.checkEditor())return;e.startLeading("g")},s:function(){if(e.checkEditor())return;var t=document.getElement(".pin-view .image-holder img");if(t&&e.leadings.leading_g){var n="https://www.google.com.hk/searchbyimage?image_url=";window.open(n+encodeURIComponent(t.src),"_blank"),e.cancelLeading("g")}},j:function(){if(e.checkEditor())return;e.scroll("down")},k:function(){if(e.checkEditor())return;e.scroll("up")},m:function(){if(e.checkEditor())return;app.page.dmController&&app.page.dmController.openFreshList()},t:function(){if(e.checkEditor())return;(new Fx.Scroll(window,{duration:"short"})).toTop()}}},startListening:function(){this.keyboard.activate()},stopListening:function(){this.keyboard.deactivate()},checkEditor:function(){return window.document.activeElement.match("input,textarea,[contenteditable=true]")},startLeading:function(e){this.cancelLeading(),clearTimeout(this.leadingTimer),this.leadings["leading_"+e]=!0,this.leadingTimer=function(){this.cancelLeading(e)}.delay(1e3,this)},cancelLeading:function(e){e?this.leadings["leading_"+e]&&delete this.leadings["leading_"+e]:this.leadings={}},showIntro:function(){var e=this;if(e.win&&e.win.isShowing)return;app.render("base/hotkeys","",function(t,n){e.win||(e.win=new SmoothNotification({style:"window",styles:{position:"fixed"},mask:!0,duration:!1})),e.win.show(Elements.from(n)[0]),e.win.main.id="hotkeys_intro"})},hideIntro:function(){this.win.hide()}});window.addEvent("domready",function(){app.hotkey||(app.hotkey=new HuabanHotkeys)});var LikeCommentForm=new Class({Implements:[Options],options:{action:"Like",pinSource:""},initialize:function(e,t,n){this.setOptions(n),this.target=document.id(e),this.pinId=t,this.build(),this.init()},init:function(){this._initRenderNewComment(),this._initCloseButton(),this._initShareButtons(),this._initSubmitButton()},_initRenderNewComment:function(){var e=this.element,t=e.getElement("textarea");this.options.action=="PinView"?this.renderNewComment=function(e){var n=$("pin_comments"),r=app.renderSync("base/comment_item",e.comment),i=Elements.from(r).inject(n);i.highlight(),t.set("value","")}:this.options.action=="Like"&&(this.renderNewComment=function(n){var r=e.getParent("div.pin"),i=r.getElement("div.write"),s=i.getPrevious("div.comments");e.removeClass("disabled"),t.set("value","");var o=app.renderSync("base/comment_item_convo",n.comment),u=Elements.from(o).inject(s);s.isDisplayed()||s.show(),u.highlight("#EEE");var a=app.page.$waterfall;a&&a.update(r)})},_initCloseButton:function(){var e=this,t=this.element.getElement(".close");t.addEvent("click",function(t){t.stop(),e.hide()})},_initShareButtons:function(){var e=this.options.action,t=this.pinId,n=this.options.pinSource;this.element.getElements(".share-button").addEvent("click",function(r){r.stop();var i=this.get("data-to");try{ga("send","event","SocialShare",i+":{js}",e+":"+n)}catch(r){}window.open("/pins/"+t+"/js-share/?to="+i)})},_initSubmitButton:function(){var e=this,t=this.pinId,n=this.renderNewComment,r=this.element,i=r.getElement(".submit-comment"),s=r.getElement("textarea"),o=function(r){(new Request.JSON({url:"/pins/"+t+"/comments/",data:{text:r},onSuccess:function(s){s.err&&s.err==412?(app.$form={pinId:t,text:r},app.requireCaptcha(n)):s.err?app.error(s.msg||app.COMMON_ERRMSG):(n(s),e.options.action=="PinView"&&app.msg("评论成功"),e.hide()),i.removeClass("disabled")},onFailure:function(){app.error(app.COMMON_ERRMSG),i.removeClass("disabled")}})).post()};i.addEvent("click",function(e){e.stop();if(r.hasClass("disabled"))return!1;var t=s.get("value").trim();if(t=="")return app.error("好歹输两个字吧，亲！");i.addClass("disable"),app.requireLogin(function(){o(t)})})},build:function(){var e="div",t="提交";this.options.action=="PinView"&&(e="li",t="添加评论");var n=new Element(e,{"class":"comment"});(new Element("a",{"class":"close",href:"#",text:"x"})).inject(n),Browser.ie&&Browser.version<9&&(new Element("div",{"class":"pointer"})).inject(n);var r=new Element("form",{actions:"/pins/"+this.pinId+"/comments/",method:"post"});(new Element("textarea",{"class":"txt",name:"text",placeholder:"说说你赞的理由吧"})).inject(r),(new Element("input",{"class":"submit-comment",type:"submit",value:t})).inject(r),(new Element("label",{text:"把这个采集推荐给好友："})).inject(r);var i=new Element("ul",{"class":"js-share-buttons"}),s={weibo:"分享到新浪微博",qzone:"分享到QQ空间",tqq:"分享到腾讯微博",douban:"分享到豆瓣",renren:"分享到人人"};for(var o in s){var u=new Element("li");(new Element("a",{"class":"share-button "+o,href:"#",title:s[o],"data-to":o})).inject(u),u.inject(i)}i.inject(r),r.inject(n),this.element=n},show:function(){this.target.setStyle("display","block"),this.element.inject(this.target);var e=this;e._hideOnOutsideClick=function(t){if(e.element.contains(t.target))return!1;e.hide()},document.body.addEvent("mouseup",e._hideOnOutsideClick)},hide:function(){this.element.dispose(),this.target.setStyle("display",""),typeof this._hideOnOutsideClick=="function"&&document.body.removeEvent("mouseup",this._hideOnOutsideClick)},focusInput:function(){var e=this.element.getElement("textarea");e.focus()}}),installHuabanChromeAddon=function(e){if(!Browser.chrome)return;if(Browser.version<26&&Browser.version>=21)return location.href="http://hbfile.b0.upaiyun.com/extensions/huaban-chrome-extension-21.crx",e&&e();if(Browser.version<21)return alert("请更新你的浏览器，Chrome 版本必须高于 26");(new Element("link",{rel:"chrome-webstore-item",href:"https://chrome.google.com/webstore/detail/imamemhokkdleoelohnmkimbmpfglcil"})).inject(document.head);if(app.page.chromeAddonInstalling)return!1;app.page.chromeAddonInstalling=!0,app.msg("安装中，请稍候...",{timeout:!1});var t=function(){$$(".floating-notice").destroy(),app.showSheet("chrome_addon"),app.page.chromeAddonInstalling=!1};chrome.webstore.install("https://chrome.google.com/webstore/detail/imamemhokkdleoelohnmkimbmpfglcil",function(){$$(".floating-notice").destroy(),e&&e()},t),setTimeout(function(){app.page.chromeAddonInstalling&&t()},3e4)},openJsShareWindow=function(e){var t=Object.append({to:"weibo",pageUrl:"",imgUrl:"",title:""},e),n=["url="+encodeURIComponent(t.pageUrl)],r="";if(t.to==="weibo")r="http://v.t.sina.com.cn/share/share.php?",n.push("&appkey=2499394483"),n.push("&pic="+t.imgUrl),n.push("&title="+t.title),n.push("&ralateUid=2493118952");else if(t.to==="douban")r="http://www.douban.com/recommend/?",n.push("&title="+t.title),n.push("&comment="+t.title);else if(t.to==="qzone")r="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?",n.push("&title="+t.title),n.push("&pics="+t.imgUrl);else if(t.to==="tqq")r="http://share.v.t.qq.com/index.php?c=share&a=index&",n.push("&title="+t.title),n.push("&appkey=801088644"),n.push("&pic="+t.imgUrl),n.push("&assname=huaban20111114");else if(t.to==="renren")r="http://widget.renren.com/dialog/share?",n.push("&title="+t.title),n.push("&pic="+t.imgUrl),n[0]=n[0].replace("url=","resourceUrl="),n.push(n[0].replace("resourceUrl=","&srcUrl="));else{if(t.to!=="qfriends")return;r="http://connect.qq.com/widget/shareqq/index.html?",n.push("&desc="+t.title),n.push("&site="+encodeURIComponent("花瓣网"))}n=n.join("");var i=[r,n].join("");window.open(i)},MenuController=new Class({Implements:[Options],options:{menu:{},trigger:{},timeout:500,showupDelay:0},initialize:function(e){this.setOptions(e);var t=this;this.timer={},this.showupTimer={},(new Elements([this.options.trigger,this.options.menu])).addEvents({mouseenter:function(){clearTimeout(t.timer)},mouseleave:function(){clearTimeout(t.timer),t.timer=function(){t.options.menu.hide().fireEvent("menu_hide")}.delay(t.options.timeout)}}),this.options.trigger.addEvents({mouseenter:function(){clearTimeout(t.showupTimer),t.showupTimer=function(){t.options.menu.show().fireEvent("menu_show")}.delay(t.options.showupDelay)},mouseleave:function(){clearTimeout(t.showupTimer)},click:function(){t.options.menu.show().fireEvent("menu_show")}})}}),CharactersChecker=new Class({Implements:[Options],options:{remainDesc:"还可以输入{count}个字符",exceedDesc:"已经超过{count}个字符",disableSubmit:!1,maxChars:140},initialize:function(e,t){this.setOptions(t),this.input=document.id(e),this.options.indicator&&(this.indicator=document.id(this.options.indicator)),this.options.submit&&(this.submit=document.id(this.options.submit)),this.attach()},attach:function(){var e=this;this.input.addEvent("keyup",function(t){if(e.indicator){var n=this.get("value").length;if(n>=e.options.maxChars){var r=e.options.exceedDesc.replace("{count}",n-e.options.maxChars);e.indicator.set("text",r)}else{var r=e.options.remainDesc.replace("{count}",e.options.maxChars-n);e.indicator.set("text",r)}}})}}),Parallax=new Class({Implements:[Options],options:{speed:.5},initialize:function(e,t){this.setOptions(t),this.el=document.id(e),this._addScrollEvent()},_addScrollEvent:function(){var e=this;window.addEvent("scroll",function(t){var n=window.getSize().y,r=window.getScroll().y,i=e.el.getCoordinates().top,s=e.el.getCoordinates().height;if(i+s<=r||i>=r+n)return;var o=Math.round(Math.abs(i-r)*e.options.speed);e.el.setStyle("background-position","center "+o+"px")})}});app.pushToBaidu=function(){var e=location.href,t=document.referrer,n="http://api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),e&&(n+="&l="+e)):e&&(n+="?l="+e);var r=new Image;r.src=n},app.gaqTrackEvent=function(e,t){var n=app.page.$url,r={elementEvent:"click",category:"",action:"click",label:n,value:null,useTargetUrlAsLabel:!1,trackPromotion:!1};t=Object.append(r,t),document.getElements(e).addEvent(t.elementEvent,function(e){var n=["send","event",t.category,t.action,t.label,t.value,{nonInteraction:1}];if(t.useTargetUrlAsLabel){var r="";r=this.get("data-real-href");if(!r){var i=e.target.match("a")?i:e.target.getParent("a");i&&(r=i.get("data-real-href"))}n[4]=r}try{t.trackPromotion?(n[0]="adsTracker.send",ga.apply(this,n)):ga.apply(this,n)}catch(e){}})},app.cnzzTrackEvent=function(e,t){var n=app.page.$url,r={elementEvent:"click",category:"",action:"click",label:n,value:1,useTargetUrlAsLabel:!1};t=Object.append(r,t),document.getElements(e).addEvent(t.elementEvent,function(e){var n=["_trackEvent",t.category,t.action,t.label,t.value];if(t.useTargetUrlAsLabel){var r=this.get("data-real-href");if(!r){var i=e.target.match("a")?i:e.target.getParent("a");i&&(r=i.get("data-real-href"))}n[3]=r}try{_czc.push(n)}catch(e){}})},app.cnzzTrackExposition=function(e){e=Object.append({category:"",action:"expose",label:app.page.$url,value:1},e);var t=["_trackEvent","expose_"+e.category,e.action,e.label,e.value];try{_czc.push(t)}catch(n){}},app.gaqTrackPromotion=function(e,t){var n=document.getElements(e);if(!n||!n.length)return;t=Object.append({category:"",action:"click",label:app.page.$url,value:null},t);var r=["adsTracker.send","event","expose_"+t.category,t.action,t.label,t.value,{nonInteraction:1}];try{ga.apply(this,r)}catch(i){}t.trackPromotion=!0,app.gaqTrackEvent(e,t)},app.oauthError=function(e){app._currentSheet?app.hideSheet(function(){app.error(e)}):app.error(e)},app.blinkMenuButton=function(e){var t=document.getElement(".menu-bar .menu-nav");if(!t)return;e=="start"?t.addClass("blink"):e=="stop"&&t.removeClass("blink")};var FormatBoardList=new Class({initialize:function(e){this.boards=e,this.pinyin=new Pinyin({keepUnknownWords:!0}),this._sort()},update:function(e){this.boards=e,this._sort()},_pinyin:function(){this.boards.each(function(e){var t=this.pinyin.getCharsArray(e.title,"detailed"),n="";for(var r=0;r<t.length;r++)if(typeof t[r]=="string")n+=t[r];else for(var i=0;i<t[r].length;i++)n+=t[r][i].full;e.pinyin=n.toUpperCase(),e.acronym=e.pinyin.charAt(0)}.bind(this))},_sort:function(){this._pinyin();var e=this.boards;this.recent=e.slice(0,5),this.sort_boards=e.slice(5).sort(function(e,t){return e.acronym>t.acronym?1:e.acronym<t.acronym?-1:0})},formatJson:function(){var e=this.sort_boards,t={};t.recent=this.recent,t.other=[],t.num=[],t.letters=[];var n=[];for(var r=0;r<e.length;r++){var i=e[r].acronym;i.test(/[A-Z]/)?r>0&&e[r-1].acronym==i?n.push(e[r]):(n=[e[r]],t.letters.push({letter:i,boards:n})):i.test(/[0-9]/)?t.num.push(e[r]):t.other.push(e[r])}return t},match:function(e,t){var n=this.recent,r=n.concat(this.sort_boards),i=[],s=this.generateReg(e);for(var o=0;o<r.length;o++){var u=r[o].pinyin.test(s,"i"),a=r[o].title.test(s,"i");if(u||a)r[o].pinyin==e||r[o].title==e?i.unshift(r[o]):i.push(r[o])}return i},generateReg:function(e){var t="*.?+$^[](){}|/\\".split("");return e.split("").map(function(e){return t.contains(e)?"\\"+e:e}).join(".*")}}),stopWindowScroll=function(e){$$(e).each(function(e){var t=null;e.addEvent("mousewheel",function(n){t||(t=e.getSize().y);var r=n.event.wheelDeltaY||n.wheel;this.scrollTop<=0&&n.wheel>0?n.preventDefault():this.getScroll().y+t-r>=this.getScrollSize().y&&(this.scrollTo(0,this.getScrollSize().y),n.preventDefault())})})},dateToHoroscope=function(e,t){if(typeof e=="object")t=e.getDate(),e=e.getMonth()+1;else if(~e.indexOf("-")){var n=e.split("-");e=n[n.length-2],t=n[n.length-1]}if(e==89&&t==64)return"龙虾";var r="魔羯水瓶双鱼牡羊金牛双子巨蟹狮子处女天秤天蝎射手魔羯",i=[20,19,21,21,21,22,23,23,23,23,22,22];return r.substr(e*2-(t<i[e-1]?2:0),2)};app.showPinViewLayer=function(e,t){var n="/pins/"+e+"/";(new Request.JSON({url:n,noCache:!0,onSuccess:function(e){if(e.err)return location.href=n;var r=e.pin,i=r.raw_text?r.raw_text.length>20?r.raw_text.substr(0,20)+"...":r.raw_text:"",s=r.user?r.user.username:"花瓣用户",o=(i?i+"@":"")+s+"采集到"+r.board.title+"("+(r.board&&r.board.pin_count)+"图)"+"_花瓣";app.setTitle(o),app.hidePinViewLayer();try{app.page.$header.element.setStyle("z-index",1)}catch(u){}app.render("base/pin_view_layer",e,function(e,n){var r=Elements.from(n)[0].inject(app.view),i=document.id("layout_elevator_item"),s=document.id("layout_elevator"),o=document.id("pin_view_layer");r.addEvent("scroll",function(){document.body.setStyle("overflow","hidden"),o.getScrollTop()>200?s.removeClass("off"):s.addClass("off")});var u=i.getElement(".plus"),a=i.getElement(".plus-popup");new MenuController({menu:a,trigger:u,showupDelay:1e3}),s.addEvent("click",function(){(new Fx.Scroll(o)).toTop()}),document.body.setStyle("overflow","hidden");var f=r.getElement(".pin-view-arrows .prev"),l=r.getElement(".pin-view-arrows .next");f&&f.setStyles({position:"fixed",left:f.getCoordinates(document.body).left}),l&&l.setStyles({position:"fixed",right:document.body.getSize().x-l.getCoordinates(document.body).right}),e&&Browser.exec(e),app.view.fireEvent("initWaterfall"),t&&t()})},onFailure:function(){window.location.href=n}})).get()},app.hidePinViewLayer=function(){try{document.body.setStyle("overflow",""),app.page.$header.element.setStyle("z-index","")}catch(e){}var t=document.id("pin_view_layer");t&&t.destroy()},app.getCaptcha=function(){var e=new Date/1,t="callback=app.tdcaptcha.showcode&rand="+e,n=app.settings.tdcaptcha.create_url;n+="?pubkey="+app.settings.tdcaptcha.public_key,n+="&"+t;var r=document.id("captcha_script");r&&r.destroy(),r=new Element("script",{id:"captcha_script",src:n}),document.body.appendChild(r)},app.gtRegister=function(e,t){(new Request.JSON({url:"/gt/register?t="+(new Date).getTime(),onSuccess:function(n){initGeetest&&initGeetest(Object.append({gt:n.data.gt,challenge:n.data.challenge,product:"float",offline:!1},t),e)},onFailure:function(n){var r=JSON.parse(n.response||"{}"),i=r.data||{};initGeetest&&initGeetest(Object.append({gt:i.gt,challenge:null,product:"float",offline:!0},t),e)}})).get()},app.gtRefresh=function(){window.captchaObj&&window.captchaObj.refresh()},app.sendSMSTo=function(e,t,n){var r=t||{};t.tel=e;var i=new Request.JSON({url:"/captcha/",method:"post",data:r,onSuccess:function(e){if(e.err)return app.alert(e.msg);n(e)},onFailure:function(e){app.alert("发送短信失败")}});i.send()},app.sendCaptchaTo=function(e){return function(){var t=new Request.JSON({url:"/email/captcha/",method:"post",data:{email:e},onSuccess:function(){app.alert("发送成功!")},onFailure:function(e){app.error(JSON.parse(e.response||"{}").error||"发送邮箱验证码失败")}});t.send()}},app.deleteTags=function(e,t){var n={url:"/pin/tags/",emulation:!1,headers:{"content-type":"application/x-www-form-urlencoded"},onSuccess:function(e){if(e.err)return app.error(e.msg);t&&t(e)},onFailure:function(e){app.error(e.responseText||"删除标签失败")}};e&&(n.data={tags:e}),(new Request.JSON(n)).delete()},app.keepTags=function(e,t){var n={url:"/pin/tags/keep/",onSuccess:function(e){if(e.err)return app.error(e.msg);delete app.req.user.status.old_tags,t&&t(e)},onFailure:function(e){app.error(e.responseText||"导入标签失败")}};e&&(n.data={tags:e}),(new Request.JSON(n)).post()},app.feedback=function(){var e=!1;return function(t,n){n=typeof n=="function"?n:function(){};if(e)return n();e=!0,setTimeout(function(){(new Request.JSON({url:"/feedback/pin",data:t,onSuccess:function(e){n()},onFailure:function(){e=!1,n()}})).post()},5e3)}}();var Validator={isEmpty:function(e){if("string"==typeof e)return 0===e.length;if(e instanceof Object){var t=Object.keys(e);return 0===t.length}return e instanceof Array?0===e.length:-1!==[undefined,null].indexOf(e)},isEmail:function(e){return-1!==e.indexOf("@")},isTel:function(e){var t=/^[+1-9]\d{5,15}$/;return t.test(e)},isPasswordLength:function(e){var t=32,n=6,r=e.length;return n<=r&&t>=r}},Settings={openUnit:function(e,t,n){e.filter(function(e){return e.id!=t.id}).each(function(e){Settings.closeUnit(e)}),t.fireEvent("open");var r=t.getElement(".inner").getSize().y;t.addClass("open").getElement(".holder").tween("height",r).get("tween").chain(function(){Browser.ie6||this.element.removeProperty("style"),location.hash="#"+t.id.substr(1),n&&docScroller.toElementCenter(t.getElement(".title"),"y")}),t.getElement(".edit-label").set("text","收起"),t.getElement(".preview").set("tween",{duration:200}).fade("out")},closeUnit:function(e){e.removeClass("open").getElement(".holder").setStyle("overflow","hidden").tween("height",0),e.getElement(".edit-label").set("text","编辑"),e.getElement(".preview").set("tween",{duration:800}).fade("in")}};(function(){var e=Cookie.read("_f");if(e&&e.length&&e.indexOf(!0))return;var t=50,n=20,r=8,i=new Element("canvas");i.width=t,i.height=n,i.style.display="inline";if(!i.getContext){i.destroy();return}var s=i.getContext("2d");s.fillStyle="cyan",s.fillRect(0,0,r,n),s.fillStyle="lightgreen",s.fillRect(t-r,0,r,n),s.font="10px serif",s.fillStyle="red",s.fillText("Huaban",r-6,8),s.fillStyle="pink",s.fillText("V 0.0.1",r+6,n/2+8);var o=i.toDataURL(),u=o.split(","),a=","+[navigator.platform,screen.width,screen.height,screen.colorDepth].join(".");Cookie.write("_f",u[1]+a),i.destroy()})(),function(){Array.isArray||(Array.isArray=function(e){return"[object Array]"==Object.prototype.toString.call(e)}),Array.getRandom||(Array.getRandom=function(e){return e.length?e[Math.floor(Math.random()*e.length)]:null}),Object.keys||(Object.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}),Object.append||(Object.append=function(e){for(var t=1,n=arguments.length;t<n;t++){var r=arguments[t]||{};for(var i in r)e[i]=r[i]}return e}),String.prototype.len||(String.prototype.len=function(){var e=this.toString(),t=0;for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r>128?t+=2:t+=1}return t}),String.prototype.brief||(String.prototype.brief=function(e,t){t=t||"...";var n=0,r="";for(var i=0,s=this.length;i<s;i++){var o=this.charCodeAt(i);o>128?n+=2:n+=1;if(!(n<=e))return r+t;r+=this.charAt(i)}return r}),String.prototype.nl2br||(String.prototype.nl2br=function(){return this.replace(/(\r|\n)+/g,"<br/>")})}(),function(){var e,t=/\\?([a-z])/gi,n=["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur","January","February","March","April","May","June","July","August","September","October","November","December"],r=function(e,t){return s[e]?s[e]():t},i=function(e,t){return(e+="").length<t?(new Array(++t-e.length)).join("0")+e:e},s={d:function(){return i(s.j(),2)},D:function(){return s.l().slice(0,3)},j:function(){return e.getDate()},l:function(){return n[s.w()]+"day"},N:function(){return s.w()||7},S:function(){var e=s.j();return e<4|e>20&&["st","nd","rd"][e%10-1]||"th"},w:function(){return e.getDay()},z:function(){var e=new Date(s.Y(),s.n()-1,s.j()),t=new Date(s.Y(),0,1);return Math.round((e-t)/864e5)+1},W:function(){var e=new Date(s.Y(),s.n()-1,s.j()-s.N()+3),t=new Date(e.getFullYear(),0,4);return i(1+Math.round((e-t)/864e5/7),2)},F:function(){return n[6+s.n()]},m:function(){return i(s.n(),2)},M:function(){return s.F().slice(0,3)},n:function(){return e.getMonth()+1},t:function(){return(new Date(s.Y(),s.n(),0)).getDate()},L:function(){var e=s.Y();return e%4==0&e%100!=0|e%400==0},o:function(){var e=s.n(),t=s.W(),n=s.Y();return n+(e===12&&t<9?-1:e===1&&t>9)},Y:function(){return e.getFullYear()},y:function(){return(s.Y()+"").slice(-2)},a:function(){return e.getHours()>11?"pm":"am"},A:function(){return s.a().toUpperCase()},B:function(){var t=e.getUTCHours()*3600,n=e.getUTCMinutes()*60,r=e.getUTCSeconds();return i(Math.floor((t+n+r+3600)/86.4)%1e3,3)},g:function(){return s.G()%12||12},G:function(){return e.getHours()},h:function(){return i(s.g(),2)},H:function(){return i(s.G(),2)},i:function(){return i(e.getMinutes(),2)},s:function(){return i(e.getSeconds(),2)},u:function(){return i(e.getMilliseconds()*1e3,6)},e:function(){throw"Not supported (see source code of date() for timezone on how to add support)"},I:function(){var e=new Date(s.Y(),0),t=Date.UTC(s.Y(),0),n=new Date(s.Y(),6),r=Date.UTC(s.Y(),6);return 0+(e-t!==n-r)},O:function(){var t=e.getTimezoneOffset(),n=Math.abs(t);return(t>0?"-":"+")+i(Math.floor(n/60)*100+n%60,4)},P:function(){var e=s.O();return e.substr(0,3)+":"+e.substr(3,2)},T:function(){return"UTC"},Z:function(){return-e.getTimezoneOffset()*60},c:function(){return"Y-m-d\\Th:i:sP".replace(t,r)},r:function(){return"D, d M Y H:i:s O".replace(t,r)},U:function(){return e/1e3|0}};Date.format=function(n,i){return arguments.length==1?(i=n,n="Y-m-d H:i:s"):arguments.length==0&&(i=null,n="Y-m-d H:i:s"),e=i==null?new Date:i instanceof Date?new Date(i):new Date(i*1e3),n.replace(t,r)},Date.prototype.format=function(e){return Date.format(e,this)}}(),function(){var e={lessThanMinuteAgo:"刚刚",minuteAgo:" 1 分钟前",minutesAgo:" {delta} 分钟前",hourAgo:" 1 小时前",hoursAgo:" {delta} 小时前",dayAgo:"昨天",daysAgo:" {delta} 天前",weekAgo:" 1 周前",weeksAgo:" {delta} 周前",monthAgo:" 1个月前",monthsAgo:" {delta} 个月前",yearAgo:" 1 年前",yearsAgo:" {delta} 年前",lessThanMinuteUntil:"从现在开始不到 1 分钟",minuteUntil:"从现在开始約 1 分钟",minutesUntil:"从现在开始约 {delta} 分钟",hourUntil:"从现在开始 1 小时",hoursUntil:"从现在开始约 {delta} 小时",dayUntil:"从现在开始 1 天",daysUntil:"从现在开始 {delta} 天",weekUntil:"从现在开始 1 星期",weeksUntil:"从现在开始 {delta} 星期",monthUntil:"从现在开始 1 个月",monthsUntil:"从现在开始 {delta} 个月",yearUntil:"从现在开始 1 年",yearsUntil:"从现在开始 {delta} 年"};Date.getTimePhrase=function(e){var t=e<0?"Until":"Ago";e<0&&(e*=-1);var n={minute:60,hour:60,day:24,week:7,month:52/12,year:12,eon:Infinity},r="lessThanMinute";for(var i in n){var s=n[i];if(e<1.5*s){e>.75*s&&(r=i);break}e/=s,r=i+"s"}return e=Math.round(e),{msg:r,delta:e,suffix:t}},Date.timeAgo=function(t){var n=t==null?new Date:t instanceof Date?new Date(t):new Date(t*1e3),r=Math.round((new Date-n)/1e3);if(r>2592e3)return Date.format("Y-m-d H:i:s",n);var i=Date.getTimePhrase(r);return e[i.msg+i.suffix].replace("{delta}",i.delta)},Date.prototype.timeAgo=function(){return Date.timeAgo(this)}}(),function(){var e=function(e,t){return e.getUTCFullYear()===t.getUTCFullYear()&&e.getUTCMonth()===t.getUTCMonth()&&e.getUTCDate()===t.getUTCDate()},t=function(e,t){return e.getUTCFullYear()===t.getUTCFullYear()&&e.getUTCMonth()===t.getUTCMonth()&&e.getUTCDate()===t.getUTCDate()-1},n=function(e,t){return e.getUTCFullYear()===t.getUTCFullYear()};Date.formatMoment=function(r){var i=r==null?new Date:r instanceof Date?new Date(r):new Date(r*1e3),s=new Date,o;return e(i,s)?o="今天 H:i":t(i,s)?o="昨天 H:i":n(i,s)?o="m 月 d 日 H:i":o="Y 年 m 月 d 日 H:i",Date.format(o,i)},Date.prototype.formatMoment=function(){return Date.formatMoment(this)}}(),function(e){return Object.append(e,{templates:{},attrs:function(t){var n=[],r=t.terse;delete t.terse;var i=Object.keys(t),s=i.length;if(s){n.push("");for(var o=0;o<s;++o){var u=i[o],a=t[u];"boolean"==typeof a||null==a?a&&(r?n.push(u):n.push(u+'="'+u+'"')):"class"==u&&Array.isArray(a)?n.push(u+'="'+e.escape(a.join(" "))+'"'):n.push(u+'="'+e.escape(a)+'"')}}return n.join(" ")},_:function(e){return e?String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):e},img:function(e,t,n,r){var i='<img src="'+this.imgURL(e,t)+'"',s=this.imgSize(e,r||t);i+=' width="'+s.w+'" height="'+s.h+'"';if(n)for(k in n)i+=" "+k+'="'+n[k]+'"';if(!n||!n.imageplus)i+=' data-baiduimageplus-ignore="1"';return i+"/>"},imgURL:function(e,t){if(!e)return"";if("string"==typeof e)return e;var n=e.bucket;"undefined"!=typeof location&&"http:"===location.protocol&&"hbimg"===n&&(n+="_http");var r="//"+this.settings.imgHosts[n]+"/"+e.key;return t?(t=this.imgSuffixIsRetinaDisplay(e.type,t),basicUrl=r+"_"+t,basicUrl):r},museImgUrl:function(e,t,n,r){var i="//"+this.settings.imgHosts[e.bucket]+"/"+e.key;switch(t){case"both":i+="_/both/"+n+"x"+r;break;default:}return i},gifURL:function(e){return/g$/.test(e)?e.substr(0,e.length-1):e+"g"},imgSuffixIsRetinaDisplay:function(e,t){if(!this.isRetinaDisplay)return t;switch(t){case"fw78":return"fw192";case"fw236":return e==="image/gif"?"fw320":"/fw/480";case"sq75":return"sq180";case"sq235":return"sq490";default:return t}},imgSize:function(e,t){if(!t)return{w:e.width,h:e.height};var n,r,i=e.width,s=e.height,o=t.substr(0,2),u=Number(t.substr(2));switch(o){case"sq":n=r=u;break;case"fm":if(u<0||i<u&&s<u)n=i,r=s;else{n=r=u;var a=n/r,f=i/s;a<f?r=Math.round(n/f):n=Math.round(r*f)}break;case"fw":i<u?(n=i,r=s):(n=u,r=Math.round(u*s/i));break;default:}return{w:n,h:r}},avatar:function(e,t){var n=this.settings.default_avatars||[],r=~n.indexOf(e&&e.avatar&&e.avatar.id);e||(e={});if(!e||!e.avatar||r)e.avatar=this.settings&&this.settings.default_avatar_img;return t=="sq75"&&(t="sq75sf"),this.imgURL(e.avatar,t||"sq75sf")},isVerified:function(e){return!1;var t},url:function(e,t){if(~e.indexOf("://"))return e;var n=t?"https":this.scheme;return n+"://"+this.host+e},parseURL:function(t){if(t===undefined||t===null||t.length===0)return;var n=document.createElement("a");n.href=t;var r={},i=["protocol","hostname","port","pathname","search","hash","host"];for(part in i)r[i[part]]=n[i[part]];return r},mkurl:function(e,t){var n=[],r;for(f in t){if(f.indexOf("_")===0)continue;t[f]=="%_page_"||t[f]=="%_limit_"?r=t[f]:r=encodeURIComponent(t[f]),t[f]&&n.push(f+"="+r)}return n.length?(e=e.replace(/\/$/,""),e+"/?"+n.join("&")):e},GACampaignURL:function(e,t){var n=[];return t.source&&n.push("utm_source="+t.source),t.medium&&n.push("utm_medium="+t.medium),t.term&&n.push("utm_term="+t.term),t.content&&n.push("utm_content="+t.content),t.name&&n.push("utm_campaign="+t.name),e+"?"+n.join("&")},format_text:function(e,t,n){e=this._(e);if(!t)return e.nl2br();var r=Array.isArray(t.mentions)&&t.mentions||[],i=Array.isArray(t.links)&&t.links||[],s=Array.isArray(t.tags)&&t.tags||[];r=r.map(function(e){return e.type="mention",e}),i=i.map(function(e){return e.type="link",e}),s=s.map(function(e){return e.type="tag",e}),t=r.concat(i,s).sort(function(e,t){return e.start-t.start});if(!t||t.length<=0)return e.nl2br();var o=[],u=0;for(var a=0;a<t.length;a++){if(t[a].start>e.length)break;if(t[a].type=="mention"&&t[a].mention_id&&t[a].user)o.push(e.substr(u,t[a].start-u)),o.push('<a class="text-meta meta-mention" href="/'+t[a].user.urlname+'/">@'),o.push(e.substr(t[a].start+1,t[a].offset-1)),o.push("</a>");else if(t[a].type=="link"){var f=e.substr(t[a].start,t[a].offset);o.push(e.substr(u,t[a].start-u));var l=f.replace(/^https?:\/\/(www\.)?/,""),c=f.match(/^(https?:\/\/).*$/),h=l,p="",d=!1;c?c=c[1]:c="",l.length>30&&(d=!0,h=l.slice(0,27),p=l.slice(27)),o.push('<a class="text-meta meta-link" rel="nofollow" href="'+f+'" title="'+f+'" target="_blank">'),o.push('<span class="invisible">'+c+"</span>"),o.push('<span class="">'+h+"</span>"),o.push('<span class="invisible">'+p+"</span>"),o.push('<span class="ellipsis"><span class="invisible">&nbsp;</span>'),d&&o.push("…"),o.push("</span></a>")}else if(t[a].type=="tag"){var v=e.substr(t[a].start+1,t[a].offset-2);o.push(e.substr(u,t[a].start-u)),n&&n.tag_icon?(o.push('<a class="text-meta meta-tag" href="/search/?q='+v+'">'),o.push('<i class="tag-icon"></i>'),o.push(v),o.push("</a>")):(o.push('<a class="text-meta meta-tag" href="/search/?q='+v+'">#'),o.push(v),o.push("#</a>"))}u=t[a].start+t[a].offset}return o.push(e.substr(u)),o.join("").nl2br()}}),e.escape=e._,e}(typeof exports=="undefined"?window.app:exports),function(e){var t=e.routers||[],n=e.botRouters||[],r=e.map=function(e,r,i){typeof e=="string"&&(e=new RegExp(e)),i?n.push([e,r]):t.push([e,r])};e.containsBotRouter=function(e){for(var t=0,r=n.length;t<r;t++)if(n[t][0].test(e))return!0};var i=e.route=function(t,n){var r=e.getRouter(t,n);if(r){var i=r.call(this,this);return this.onRoute&&(this._firstOnRoute=!0,this.onRoute(i)),i}return!1};e.getRouter=function(e,r){e=(e||this.page.$url).split("?")[0];if(r)for(var i=0,s=n.length;i<s;i++)if(n[i][0].test(e))return n[i][1];for(var i=0,s=t.length;i<s;i++)if(t[i][0].test(e))return t[i][1];return null},r(/^\/pins\/\d+\/?$/,function(t){var n=e.view||{},r=t.page,i=r.pin,s={};t.settings.categories.forEach(function(e){s[e.id]=e.name});var o=i.raw_text?i.raw_text.length>20?i.raw_text.substr(0,20)+"...":i.raw_text:"",u=i.user?i.user.username:"花瓣用户",a=i.board.category_id?s[i.board.category_id]:"";return r.title=(o?o+"@":"")+u+"采集到"+i.board.title+"("+(i.board&&i.board.pin_count)+"图)"+"_花瓣"+a,r.category_name=a,t.render("spider/pin_view",n)},!0),r(/^\/boards\/\d+\/?$/,function(t){var n=e.view||{},r=t.page,i=r.board;return r.title=(i.is_private==2?"待归类采集":i.title)+"("+i.pin_count+"图)_@"+(i.user?i.user.username:"")+"收集_花瓣"+(i.category_name||""),t.render("spider/board_view",n)},!0),r(/^\/(?!(search|all|following|from|popular|favorite|gift))[a-z0-9-_\.]+(\/about|)\/?$/,function(t){s(t);var n=e.view||{};return t.render("spider/user_view",n)},!0),r(/^\/((all|following|from|popular|favorite)(\/([^\/]+)(\/youku|\/ku6|\/56|\/baomihua)?)?)?\/?$/,function(t){var n=e.view||{};return t.page.show_categories_bar=!t.page.filter||!~t.page.filter.indexOf("site:"),t.render("base/index",n,function(e,r){n.show();var i=t.page.page||!1,s=20;t.page.$waterfall=(new Waterfall("waterfall",{scrollTimes:2,maxScrollTimes:4,fetcher:!~t.page.$url.indexOf("popular"),loader:t.createCellLoader(t.page.$url,s,i,function(e){t.page.pins&&Array.prototype.push.apply(t.page.pins,e.pins);var n=e.pins;return n.forEach(function(e,r){var i=t.page.ads.getAd();i&&i.length&&n.splice(r,0,i[0])}),{data:n}})})).reposition()})}),r(/^\/explore(\/([^\/]+))?\/?$/,function(t){var n=e.view||{};return t.page.keyword_id?t.render("explore/detail",n,function(e,r){n.show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,i,function(e){return t.page.pins&&Array.prototype.push.apply(t.page.pins,e.pins),{data:e.pins}},{template:"base/pin_item"})})).reposition()}):t.render("explore/explore_old",n,function(e,r){n.show(),t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,1,function(e){return{data:e.pins||e.boards}})})).reposition(),t.page.nox=!0})}),r(/^\/users\/((all|favorite|popular)(\/([^\/]+))?)?\/?$/,function(t){var n=e.view||{};return t.render("base/promote_users",n,function(e,t){n.show()})}),r(/^\/boards\/((all|favorite|popular)(\/([^\/]+))?)?\/?$/,function(t){var n=e.view||{};return t.page.show_categories_bar=!0,t.render("base/index",n,function(e,r){n.show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,i,function(e){return t.page.boards&&Array.prototype.push.apply(t.page.boards,e.boards),{data:e.boards}})})).reposition()})}),r(/^\/search(\/(pins|boards|people|gift|self_pins|self_boards))?\/?$/,function(t){var n=e.view||{};return t.render("base/search_result",n,function(e,r){var i=[{google:!0,slot:"2865654831",width:200,height:200,className:"pin wfc promotion google search"},{google:!0,slot:"4342362711",width:200,height:200,className:"pin wfc promotion google search"},{google:!0,slot:"2865654831",width:200,height:200,className:"pin wfc promotion google search"},{google:!0,slot:"4342362711",width:200,height:200,className:"pin wfc promotion google search"}],s;t.page.query.type=="people"?s="users":t.page.query.type=="gift"||"self_pin"===t.page.query.type?s="pins":s=t.page.query.type+"s";var o=0;n.show(),t.page.$waterfall=(new Waterfall("waterfall",{scrollTimes:2,maxScrollTimes:4,loader:t.createCellLoader(t.page.$url,20,1,function(e){t.page[s]&&Array.prototype.push.apply(t.page[s],e[s]);var n=e[s];return n.forEach(function(e,r){if(!t.page.ads)return;var i=t.page.ads.getAd();i&&i.length&&n.splice(r,0,i[0])}),o%2===0&&i[o/2-1]&&n.splice(0,0,i[o/2-1]),{page:e.page,data:n}})})).reposition(),s==="pins"&&t.page.$waterfall.addEvent("loadComplate",function(){o%2===0&&i[o/2-1]&&(adsbygoogle=window.adsbygoogle||[]).push({}),o++})})}),r(/^\/pins\/\d+\/?$/,function(t){var n=e.view||{},r=t.page,i=r.pin,s={};t.settings.categories.forEach(function(e){s[e.id]=e.name});var o=i.raw_text?i.raw_text.length>20?i.raw_text.substr(0,20)+"...":i.raw_text:"",u=i.user?i.user.username:"花瓣用户",a=i.board.category_id?s[i.board.category_id]:"";return r.title=(o?o+"@":"")+u+"采集到"+i.board.title+"("+(i.board&&i.board.pin_count)+"图)"+"_花瓣"+a,t.render("base/pin_view_page",n,function(e,t){return n.addClass("view").show(),n.fireEvent("initWaterfall"),!1})}),r(/^\/pins\/\d+\/zoom\/?$/,function(t){var n=e.view||{},r=t.page,i=r.pin,s={};t.settings.categories.forEach(function(e){s[e.id]=e.name});var o=i.raw_text?i.raw_text.length>20?i.raw_text.substr(0,20)+"...":i.raw_text:"",u=i.user?i.user.username:"花瓣用户",a=i.board.category_id?s[i.board.category_id]:"";return r.title=o+"@"+u+"采集到"+i.board.title+"("+(i.board&&i.board.pin_count)+"图)"+"_花瓣"+a,t.render("base/pin_view_zoom",n,function(e,t){return n.addClass("view").show(),!1})}),r(/^\/boards\/\d+\/?$/,function(t){var n=e.view||{},r=t.page,i=r.board;return r.title=(i.is_private==2?"待归类采集":i.title)+"("+i.pin_count+"图)_@"+(i.user?i.user.username:"")+"收集_花瓣"+(i.category_name||""),t.render("base/board_view",n,function(e,i){n.show(),t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,function(e){return t.page.board&&Array.prototype.push.apply(t.page.board.pins,e.board.pins),{data:e.board.pins,extra:{user:e.board.user,board:e.board,hide_user:!0}}})})).reposition(),function(){if(~window.location.href.indexOf("setcover=1")&&t.req.user.user_id==r.board.user_id){var e=function(){$$(".pin .actions .left .repin").each(function(e){e.getParent(".left").set("html",'<a title="设置封面" href="#" onclick="return false;" class="set cover-change btn btn14"><span class="text"> 设置封面</span></a>')})};e(),t.page.$waterfall.addEvent("loadComplate",e),t.view.addEvent("click:relay(.cover-change)",function(){t.dialog={};var e=this;t.dialog.board_id=t.page.board.board_id,t.dialog.pin_id=e.getParent(".pin").get("data-id"),t.showDialog("board_cover_pinitem");var n=this.getParent(".pin").getElement(".img img").src;return n=n.replace(/_.*$/,"_sq235"),document.getElement("#board_cover_pinitem .cover img").src=n,!1})}}()})}),r(/^\/boards\/\d+\/followers\/?$/,function(t){var n=e.view||{},r=t.page,i=r.board;return t.render("base/board_view",n,function(e,r){n.show(),t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:"div.person-item",loader:t.createCellLoader(t.page.$url,20,function(e){return{data:e.followers}},{template:"base/person_item"})})).reposition()})}),r(/^\/bookmarklet_success\/?$/,function(t){var n=e.view||{};return t.render("base/bookmarklet_success",n,function(e,t){n.show()})}),r(/^\/message\/(mentions|activities)\/?$/,function(t){var n=e.view||{};return t.render("messages_deprecated/message",n,function(e,t){return n.addClass("view").show(),!1})}),r(/^\/_error\/?$/,function(t){var n=e.view||{};return t.render("base/error",n,function(e,t){n.show()})});var s=function(e){var t=e.page,n=t.user;t.title=n&&n.username?n.username+"的花瓣个人主页":""};return r(/^\/[a-z0-9-_\.]+(\/about|)\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_boards",n,function(e,r){n.addClass("profile").show(),t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:!1})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/muse_boards\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_muse_boards",n,function(e,r){n.addClass("profile").show(),t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:!1})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/pins\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_pins",n,function(e,r){n.addClass("profile").show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,i,function(e){var t=e.user.pins;return t.each(function(t){t.user=e.user}),{data:t}})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/commodities\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_commodities",n,function(e,r){n.addClass("profile").show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,i,function(e){var t=e.user.commodities;return t.each(function(t){t.user=e.user}),{data:t}})})).reposition()})}),r(/^\/shiji\/following\/?/,function(t){var n=e.view;return t.render("shiji/following",n,function(e,r){n.show(),t.page.$waterfall=new Waterfall("waterfall",{hibernate:!1,paddingBottom:!0,cellWidth:320,cellSpace:20,minCols:3,maxCols:3,containerSelector:null,container:"waterfall"})})}),r(/^\/[a-z0-9-_\.]+\/following\/explores\/?$/,function(t){s(t),t.page.filter="explores";var n=e.view||{};return t.render("base/people_following",n,function(e,r){n.show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:"div.explore-board",loader:t.createCellLoader(t.page.$url,20,i,function(e){return{data:e.explores}},{template:"base/explore_board"})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/following\/boards\/?$/,function(t){s(t),t.page.filter="boards";var n=e.view||{};return t.render("base/people_following",n,function(e,r){n.show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,i,function(e){return t.page.boards&&Array.prototype.push.apply(t.page.boards,e.boards),{data:e.boards}})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/following\/?$/,function(t){s(t),t.page.filter="users";var n=e.view||{};return t.render("base/people_following",n,function(e,r){n.addClass("profile").show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:"div.person-item",loader:t.createCellLoader(t.page.$url,20,function(e){return{data:e.users}},{template:"base/person_item"})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/followers\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_followers",n,function(e,r){n.addClass("profile").show();var i=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{cellSelector:"div.person-item",loader:t.createCellLoader(t.page.$url,20,function(e){return{data:e.users}},{template:"base/person_item"})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/likes\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_likes",n,function(e,r){n.addClass("profile").show(),t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,function(e){return{data:e.user.likes}})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/likes\/boards\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_likes_boards",n,function(e,r){n.addClass("profile").show(),t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,function(e){return{data:e.user.likes_boards}})})).reposition()})}),r(/^\/[a-z0-9-_\.]+\/tags\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_tags",n,function(){n.addClass("profile").show(),t.page.$waterfall=(new Waterfall("waterfall")).reposition()})}),r(/^\/[a-z0-9-_\.]+\/tags\/[\u0000-\uFFFF]+\/pins\/?$/,function(t){s(t);var n=e.view||{};return t.render("base/people_tag_pins",n,function(){n.addClass("profile").show();var e=t.page.page||!1;t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,e,function(e){return{data:e.pins}})})).reposition()})}),r(/^\/fm\/\w+(\/(pins|boards))?(\/[^/]+)?\/?$/,function(t){var n=e.view||{};return t.render("channel/channel",n,function(e,r){n.addClass("channel").show();var i={container:"channel_container"};t.page.pager!="normal"?i.loader=t.createCellLoader(t.page.$url,20,function(e){var t=e.view_type;if(t=="pins"){var n=e.pins;return{data:n}}if(t=="boards"){var r=e.boards;return{data:r}}},{template:t.page.boards?"base/board_item":"base/pin_item"}):i.containerSelectorOffset=0,t.page.$waterfall=(new Waterfall("waterfall",i)).reposition()})}),r(/^\/explore\/[A-Za-z0-9-_\.]+/,function(t){var n=e.view;return t.render("explore",n,function(e,r){n.show(),t.page.$waterfall=(new Waterfall("waterfall",{loader:t.createCellLoader(t.page.$url,20,1,function(e){return{data:e.pins||e.boards}})})).reposition(),t.page.nox=!0})}),e}(typeof exports=="undefined"?window.app:exports);var Autocompleter={},OverlayFix=IframeShim;Autocompleter.Base=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:!0,width:"inherit",maxChoices:10,className:"autocompleter-choices",zIndex:42,delay:400,observerOptions:{},fxOptions:{},autoSubmit:!1,overflow:!1,overflowMargin:25,selectFirst:!1,filter:null,filterCase:!1,filterSubset:!1,forceSelect:!1,selectMode:!0,choicesMatch:null,multiple:!1,separator:", ",autoTrim:!0,allowDupes:!1,cache:!0,relative:!1},initialize:function(e,t){this.element=document.id(e),this.setOptions(t),this.options.separatorSplit=new RegExp("\\s*["+this.options.separator+"]\\s*"),this.build(),this.observer=new Observer(this.element,this.prefetch.bind(this),Object.merge({delay:this.options.delay},this.options.observerOptions)),this.queryValue=null,this.options.filter&&(this.filter=this.options.filter.bind(this));var n=this.options.selectMode;this.typeAhead=n=="type-ahead",this.selectMode=n===!0?"selection":n,this.cached=[]},build:function(){if(document.id(this.options.customChoices))this.choices=this.options.customChoices;else{this.choices=(new Element("ul",{"class":this.options.className,styles:{display:"none",zIndex:this.options.zIndex}})).inject(document.body),this.relative=!1;if(this.options.relative||this.element.getOffsetParent()!=document.body)this.choices.inject(this.element,"after"),this.relative=this.element.getOffsetParent(),function(){this.relative=this.element.getOffsetParent()}.bind(this).delay(1e3);this.fix=new OverlayFix(this.choices)}this.options.separator.test(this.options.separatorSplit)||(this.options.separatorSplit=this.options.separator),this.fx=this.options.fxOptions?(new Fx.Tween(this.choices,Object.merge({property:"opacity",link:"cancel",duration:200},this.options.fxOptions))).addEvent("onStart",Chain.prototype.clearChain).set(0):null,this.element.setProperty("autocomplete","off").addEvent(Browser.ie||Browser.chrome||Browser.safari?"keydown":"keypress",this.onCommand.bind(this)).addEvent("click",this.onCommand.bind(this,!1)).addEvent("focus",function(){this.toggleFocus.delay(100,this,[!0])}.bind(this))},destroy:function(){this.fix&&this.fix.dispose(),this.choices=this.selected=this.choices.destroy()},toggleFocus:function(e){this.focussed=e,e||this.hideChoices(!0),this.fireEvent(e?"onFocus":"onBlur",[this.element])},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift)switch(e.key){case"enter":case"tab":if(this.selected&&this.visible)return this.choiceSelect(this.selected),!!this.options.autoSubmit;break;case"up":case"down":if(!this.prefetch()&&this.queryValue!==null){var t=e.key=="up";return this.choiceOver((this.selected||this.choices)[this.selected?t?"getPrevious":"getNext":t?"getLast":"getFirst"](this.options.choicesMatch),!0),!1}break;case"esc":this.hideChoices(!0)}return!0},setSelection:function(e){var t=this.selected.inputValue,n=t,r=this.queryValue.length,i=t.length;t.substr(0,r).toLowerCase()!=this.queryValue.toLowerCase()&&(r=0);if(this.options.multiple){var s=this.options.separatorSplit;n=this.element.value,r+=this.queryIndex,i+=this.queryIndex;var o=n.substr(this.queryIndex).split(s,1)[0];n=n.substr(0,this.queryIndex)+t+n.substr(this.queryIndex+o.length);if(e){var u=/[^\s,]+/,a=n.split(this.options.separatorSplit).filter(u.test,u);this.options.allowDupes||(a=[].combine(a));var f=this.options.separator;n=a.join(f)+f,i=n.length}}this.observer.setValue(n),this.opted=n;if(e||this.selectMode=="pick")r=i;this.element.selectRange(r,i),this.fireEvent("onSelection",[this.element,this.selected,n,t])},showChoices:function(){var e=this.options.choicesMatch,t=this.choices.getFirst(e);this.selected=this.selectedValue=null;if(this.fix){var n=this.element.getCoordinates(this.relative),r=this.options.width||"auto";this.choices.setStyles({left:n.left,top:n.bottom,width:r===!0||r=="inherit"?n.width:r})}if(!t)return;this.visible||(this.visible=!0,this.choices.setStyle("display",""),this.fx&&this.fx.start(1),this.fireEvent("onShow",[this.element,this.choices])),(this.options.selectFirst||this.typeAhead||t.inputValue==this.queryValue)&&this.choiceOver(t,this.typeAhead);var i=this.choices.getChildren(e),s=this.options.maxChoices,o={overflowY:"hidden",height:""};this.overflown=!1;if(i.length>s){var u=i[s-1];o.overflowY="scroll",o.height=u.getCoordinates(this.choices).bottom,this.overflown=!0}this.choices.setStyles(o),this.fix.show()},hideChoices:function(e){if(e){var t=this.element.value;this.options.forceSelect&&(t=this.opted),this.options.autoTrim&&(t=t.split(this.options.separatorSplit).filter(function(){return arguments[0]}).join(this.options.separator)),this.observer.setValue(t)}if(!this.visible)return;this.visible=!1,this.observer.clear();var n=function(){this.choices.setStyle("display","none"),this.fix.hide()}.bind(this);this.fx?this.fx.start(0).chain(n):n(),this.fireEvent("onHide",[this.element,this.choices])},prefetch:function(){var e=this.element.value,t=e;if(this.options.multiple){var n=this.options.separatorSplit,r=e.split(n),i=this.element.getCaretPosition(),s=e.substr(0,i).split(n),o=s.length-1;i-=s[o].length,t=r[o]}if(t.length<this.options.minLength)this.hideChoices();else if(t===this.queryValue||this.visible&&t==this.selectedValue){if(this.visible)return!1;this.showChoices()}else this.queryValue=t,this.queryIndex=i,this.fetchCached()||this.query();return!0},fetchCached:function(){return!this.options.cache||!this.cached||!this.cached.length||this.cached.length>=this.options.maxChoices||this.queryValue?!1:(this.update(this.filter(this.cached)),!0)},update:function(e){this.choices.empty(),this.cached=e,!e||!e.length?this.hideChoices():(this.options.maxChoices<e.length&&!this.options.overflow&&(e.length=this.options.maxChoices),e.each(this.options.injectChoice||function(e){var t=new Element("li",{html:this.markQueryValue(e)});t.inputValue=e,this.addChoiceEvents(t).inject(this.choices)},this),this.showChoices())},choiceOver:function(e,t){if(!e||e==this.selected)return;this.selected&&this.selected.removeClass("autocompleter-selected"),this.selected=e.addClass("autocompleter-selected"),this.fireEvent("onSelect",[this.element,this.selected,t]);if(!t)return;this.selectedValue=this.selected.inputValue;if(this.overflown){var n=this.selected.getCoordinates(this.choices),r=this.options.overflowMargin,i=this.choices.scrollTop,s=this.choices.offsetHeight,o=i+s;n.top-r<i&&i?this.choices.scrollTop=Math.max(n.top-r,0):n.bottom+r>o&&(this.choices.scrollTop=Math.min(n.bottom-s+r,o))}this.selectMode&&this.setSelection()},choiceSelect:function(e){e&&this.choiceOver(e),this.setSelection(!0),this.queryValue=!1,this.hideChoices()},filter:function(e){return(e||this.tokens).filter(function(e){return this.test(e)},new RegExp((this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp(),this.options.filterCase?"":"i"))},markQueryValue:function(e){if(!this.options.markQuery||!this.queryValue)return e;var t=new RegExp("("+(this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp()+")",this.options.filterCase?"":"i");return e.replace(t,'<a class="autocompleter-queried">$1</a>')},addChoiceEvents:function(e){return e.addEvents({mouseover:this.choiceOver.bind(this,e),click:this.choiceSelect.bind(this,e)})}});var Observer=new Class({Implements:[Options,Events],options:{periodical:!1,delay:1e3},initialize:function(e,t,n){this.setOptions(n),this.addEvent("onFired",t),this.element=document.id(e)||$$(e),this.boundChange=this.changed.bind(this),this.resume()},changed:function(){var e=this.element.get("value");if($equals(this.value,e))return;this.clear(),this.value=e,this.timeout=this.onFired.delay(this.options.delay,this)},setValue:function(e){return this.value=e,this.element.set("value",e),this.clear()},onFired:function(){this.fireEvent("onFired",[this.value,this.element])},clear:function(){return clearTimeout(this.timeout||null),this},pause:function(){return clearTimeout(this.timeout),clearTimeout(this.timer),this.element.removeEvent("keyup",this.boundChange),this},resume:function(){return this.value=this.element.get("value"),this.options.periodical?this.timer=this.changed.periodical(this.options.periodical,this):this.element.addEvent("keyup",this.boundChange),this}}),$equals=function(e,t){return e==t||JSON.encode(e)==JSON.encode(t)};(function(){var e=new RegExp(/\@[^\s]{0,32}/g),t=new RegExp(/^\@[^\s]{0,32}$/);Autocompleter.Contacts=new Class({Extends:Autocompleter.Base,Implements:StyleWriter,options:{delay:100,allowDupes:!1,multiple:!1,selectMode:"pick",className:"ac-choices",css:".ac-choices {position: absolute;background: #fff;border: 1px solid #ccc;}\n.ac-choices {-webkit-box-shadow: 0 1px 5px rgba(0,0,0,.2);-moz-box-shadow: 0 1px 5px rgba(0,0,0,.2);box-shadow: 0 1px 5px rgba(0,0,0,.2);}\n.ac-choices li {padding: 3px 5px;cursor: pointer;white-space: nowrap;overflow: hidden;}\n.ac-choices li:hover {background: #f5f5f5;}\n.ac-choices li img {float: left;}\n.ac-choices li span {margin-left: 5px;line-height: 24px;}\n.ac-choices li span.ac-username {font-size: 14px;}\n.ac-choices li span.ac-urlname {color: #ccc;}\n.ac-choices li.autocompleter-selected {background: #f5f5f5;}\n.ac-choices li .autocompleter-queried {background: #d2f092;}\n",cssId:"autocompleter"},initialize:function(e,t){this.parent(e,t),this.options.injectChoice=this.injectChoice,this.createStyle(this.options.css,this.options.cssId),this.loadTokens()},loadTokens:function(e){if(!app.req.user)this.tokens=[];else{var t=this.queryValue?this.queryValue.replace("@","").toLowerCase():"";if(t===""&&this.friendList){this.tokens=this.friendList,e&&e();return}this.requestTimer&&clearTimeout(this.requestTimer),this.requestTimer=setTimeout(function(){(new Request.JSON({url:"/"+app.req.user.urlname+"/friends/",data:{q:t},onSuccess:function(n){t===""&&(this.friendList=n.users),this.tokens=n.users,e&&e()}.bind(this)})).get()}.bind(this),300)}},query:function(){var e=this;e.loadTokens(function(){e.update(e.tokens)})},queryForMatching:function(){return this.queryValue||""},valueForInput:function(e){return e.username},injectChoice:function(e){var t=(new Element("li")).adopt(new Element("img",{styles:{width:24,height:24},src:app.avatar(e)})).adopt((new Element("span",{"class":"ac-username"})).set("html",this.markQueryValue(e.username)));t.inputValue=this.valueForInput(e),this.addChoiceEvents(t).inject(this.choices)},markQueryValue:function(e){if(!this.options.markQuery||!this.queryValue)return e;var t=this.queryForMatching();if(!t)return e;var n=new RegExp("("+(this.options.filterSubset?"":"^")+t.escapeRegExp()+")",this.options.filterCase?"":"i");return e.replace(n,'<a class="autocompleter-queried">$1</a>')}}),Autocompleter.Contacts.At=new Class({Extends:Autocompleter.Contacts,options:{selectFirst:!0,allowDupes:!0,multiple:!0,separator:" "},prefetch:function(){var t=this.element.value,n=null,r=-1,i=t.match(e);if(i){var s=this.element.getCaretPosition(),o=t.substr(0,s).match(e);if(o){var u=o.length-1;r=s-o[u].length,t.substr(r,1)=="@"?n=i[u]:r=-1}}if(!n||n.length<this.options.minLength)this.hideChoices();else if(n===this.queryValue||this.visible&&n==this.selectedValue){if(this.visible)return!1;this.showChoices()}else this.queryValue=n,this.queryIndex=r,this.fetchCached()||this.query();return!0},queryForMatching:function(){return(this.queryValue||"@").substr(1)},valueForInput:function(e){var n="@"+e.username;return t.test(n)?n:"@"+e.username}})}).call(this);